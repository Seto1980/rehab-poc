<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rehab-Vis Pro v6 (2-Step Calib)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- å…¨ä½“è¨­å®š --- */
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: "Helvetica Neue", Arial, sans-serif; }
        
        canvas#output_canvas { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            object-fit: cover; transform: scaleX(-1); z-index: 1;
        }
        .graph-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0; height: 25vh;
            background: rgba(0, 0, 0, 0.85); border-top: 1px solid #444; z-index: 10;
        }
        #chart_canvas { width: 100%; height: 100%; }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* å·¦å³åˆ‡æ›¿ */
        .hand-switch-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 6000; pointer-events: auto;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 30px;
            display: flex; gap: 10px; border: 1px solid #666;
        }
        .hand-btn {
            background: transparent; border: none; color: #ccc;
            padding: 8px 16px; font-weight: bold; cursor: pointer; border-radius: 20px;
        }
        .hand-btn.active { background: #00ffcc; color: #000; box-shadow: 0 0 10px #00ffcc; }

        /* ãƒãƒ‹ãƒ¥ã‚¢ãƒ« */
        #manual-modal {
            display: none; pointer-events: auto; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; overflow-y: auto;
        }
        .manual-content {
            background: #1a1a1a; margin: 40px auto; padding: 30px; width: 90%; max-width: 600px;
            border-radius: 15px; border: 1px solid #444; color: #eee; text-align: left;
            padding-bottom: 60px;
        }
        .manual-badge {
            background: #00ffcc; color: #000; padding: 5px 10px; border-radius: 4px;
            font-weight: bold; font-size: 12px; display: inline-block; margin-bottom: 10px;
        }
        .manual-h3 { color:#00ffcc; border-bottom:1px solid #444; padding-bottom:5px; margin-top:25px; font-size: 18px; font-weight: bold; }
        .manual-p { font-size: 14px; line-height: 1.6; color: #ccc; margin: 10px 0; }
        .manual-li { font-size: 14px; line-height: 1.6; color: #ccc; margin-left: 20px; margin-bottom: 5px; }
        .manual-warn { 
            border: 1px solid #ff5555; background: rgba(255,85,85,0.15); 
            padding: 15px; border-radius: 8px; font-size: 13px; color: #ffcccc; margin-top: 15px;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            pointer-events: auto; text-align: center;
            background: rgba(0,0,0,0.85); padding: 40px; border-radius: 20px; border: 1px solid #555;
        }
        #start-btn {
            background: linear-gradient(135deg, #00ffcc, #0099aa);
            border: none; padding: 15px 50px; font-size: 20px; 
            font-weight: bold; border-radius: 50px; cursor: pointer; margin-top: 25px;
            color: #000; box-shadow: 0 0 15px rgba(0,255,204,0.3);
        }
        #help-btn {
            margin-top: 15px; background: transparent; border: 1px solid #666; color: #aaa;
            padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 14px;
        }

        /* ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”»é¢ */
        #calibration-ui { display: none; text-align: center; background: rgba(0,0,0,0.85); padding: 30px; border-radius: 20px; border: 2px solid #ffcc00; width: 80%; max-width: 400px; }
        .calib-step { font-size: 14px; color: #aaa; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .calib-title { font-size: 24px; color: #ffcc00; font-weight: bold; margin-bottom: 10px; }
        .calib-desc { font-size: 16px; color: #fff; line-height: 1.5; }
        .calib-timer { font-size: 60px; color: #fff; font-weight: bold; margin-top: 15px; }

        /* è¨ˆæ¸¬ä¸­ */
        #recording-ui { display: none; text-align: center; width: 100%; }
        .timer { font-size: 80px; color: #fff; font-weight: bold; line-height: 1; }
        .realtime-box { 
            display: flex; justify-content: center; gap: 20px; margin-top: 10px; 
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px;
        }
        .rt-item { text-align: center; }
        .rt-label { font-size: 11px; color: #aaa; margin-bottom: 3px; }
        .rt-val { font-size: 32px; font-weight: bold; color: #00ffcc; }
        .rt-sub-val { font-size: 18px; color: #00ffcc; font-weight: bold; }
        .rt-unit { font-size: 14px; color: #888; margin-left: 2px;}

        /* çµæœç”»é¢ */
        #result-ui {
            display: none; pointer-events: auto; background: rgba(20,20,20,0.98);
            padding: 30px; border-radius: 20px; border: 2px solid #00ffcc;
            width: 340px; color: #fff; text-align: center;
        }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .res-box { background: #333; padding: 10px; border-radius: 8px; }
        .res-label { font-size: 10px; color: #aaa; margin-bottom: 5px; }
        .res-big { font-size: 24px; font-weight: bold; color: #fff; }
        .retry-btn { background: #444; color: #fff; padding: 12px 30px; border-radius: 30px; border: none; cursor: pointer; font-size: 16px; margin-top: 10px; }
        
        .debug-state { font-size: 12px; color: #555; margin-top: 5px; }
    </style>
</head>
<body>
    <video id="input_video" style="display:none" autoplay playsinline></video>

    <div class="hand-switch-container">
        <button class="hand-btn" id="btn-left" onclick="setHand('left')">å·¦è…• (Left)</button>
        <button class="hand-btn active" id="btn-right" onclick="setHand('right')">å³è…• (Right)</button>
    </div>

    <div id="manual-modal">
        <div class="manual-content">
            <span class="manual-badge">èªå®šä½œæ¥­ç™‚æ³•å£«ç›£ä¿®</span>
            <h2 style="color:#fff; margin-top:5px; border-bottom:1px solid #555; padding-bottom:15px;">å–æ‰±èª¬æ˜æ›¸ (v6)</h2>
            
            <div class="manual-h3">1. ç›®çš„ (Purpose)</div>
            <p class="manual-p">
                æœ¬ã‚¢ãƒ—ãƒªã¯ã€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ä¸Šè‚¢ã®ã€Œãƒªãƒ¼ãƒç¯„å›²ï¼ˆå¯å‹•åŸŸï¼‰ã€ã‚’å€‹åˆ¥ã«æ¸¬å®šã—ã€ãã®ç¯„å›²å†…ã§ã®é‹å‹•ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆå›æ•°ã€é€Ÿåº¦ï¼‰ã‚’è©•ä¾¡ã—ã¾ã™ã€‚<br>
                ã€Œé–‹å§‹ä½ç½®ã€ã¨ã€Œæœ€å¤§ä½ç½®ã€ã®ä¸¡æ–¹ã‚’æœ€åˆã«è¨˜æ†¶ã™ã‚‹ã“ã¨ã§ã€ä¿¡é ¼æ€§ã®é«˜ã„ã‚«ã‚¦ãƒ³ãƒˆã‚’è¡Œã„ã¾ã™ã€‚
            </p>

            <div class="manual-h3">2. æ­£ã—ã„ä½¿ã„æ–¹ (2æ®µéšè¨­å®š)</div>
            <p class="manual-p">æ¸¬å®šã‚’é–‹å§‹ã™ã‚‹ã¨ã€ã¾ãš<strong>2å›</strong>ã®æº–å‚™æ™‚é–“ãŒã‚ã‚Šã¾ã™ã€‚</p>

            <p class="manual-p"><strong>STEP 1: ãƒ›ãƒ¼ãƒ ä½ç½®ã®ç™»éŒ²</strong><br>
            æœ€åˆã®5ç§’ã§ã€<span style="color:#00ffcc;">æ‰‹ã‚’è†ã®ä¸Šï¼ˆã¾ãŸã¯æœºã®æ‰‹å‰ï¼‰ã«ç½®ã„ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãã ã•ã„ã€‚</span><br>
            ã“ã‚ŒãŒã€Œ0%ã€ã®åŸºæº–ã«ãªã‚Šã¾ã™ã€‚</p>
            
            <p class="manual-p"><strong>STEP 2: æœ€å¤§ãƒªãƒ¼ãƒã®ç™»éŒ²</strong><br>
            æ¬¡ã®5ç§’ã§ã€<span style="color:#ffcc00;">è…•ã‚’é™ç•Œã¾ã§é ãã«ä¼¸ã°ã—ã¦ãã ã•ã„ã€‚</span><br>
            ã“ã‚ŒãŒã€Œ100%ã€ã®åŸºæº–ã«ãªã‚Šã¾ã™ã€‚</p>

            <p class="manual-p"><strong>STEP 3: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</strong><br>
            è¨­å®šã—ãŸã€Œ0%ã€œ100%ã€ã®ç¯„å›²ã‚’ä½¿ã£ã¦è¨ˆæ¸¬ã—ã¾ã™ã€‚<br>
            ãƒ»<span style="color:#00ffcc">80%</span>ã¾ã§ä¼¸ã°ã™ã¨ã€Œãƒªãƒ¼ãƒã€<br>
            ãƒ»<span style="color:#ff3366">20%</span>ã¾ã§æˆ»ã™ã¨ã€Œ1å›ã€ã¨ã‚«ã‚¦ãƒ³ãƒˆã€‚</p>

            <div class="manual-h3">3. ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãƒ»æ³¨æ„ç‚¹</div>
            <div class="manual-warn">
                <ul>
                    <li><strong>å¥¥è¡Œãè¨ˆæ¸¬ã®é™ç•Œ:</strong> å˜çœ¼ã‚«ãƒ¡ãƒ©ã®ãŸã‚ã€å¥¥è¡Œãã®çµ¶å¯¾è·é›¢(cm)ã«ã¯èª¤å·®ãŒã‚ã‚Šã¾ã™ã€‚æœ¬ã‚¢ãƒ—ãƒªã¯ã€Œã‚ãªãŸã®ãƒ›ãƒ¼ãƒ ä½ç½®ã€ã¨ã€Œã‚ãªãŸã®æœ€å¤§ä½ç½®ã€ã®å·®åˆ†ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã“ã®èª¤å·®ã‚’æœ€å°é™ã«æŠ‘ãˆã¦ã„ã¾ã™ã€‚</li>
                    <li><strong>èªè­˜ã‚¨ãƒ©ãƒ¼:</strong> æœ€åˆã®è¨­å®šï¼ˆStep1, Step2ï¼‰ã§æ­£ã—ããƒãƒ¼ã‚ºã‚’å–ã‚‰ãªã„ã¨ã€ãã®å¾Œã®ã‚«ã‚¦ãƒ³ãƒˆãŒåå¿œã—ã¾ã›ã‚“ã€‚</li>
                    <li><strong>ç’°å¢ƒ:</strong> é€†å…‰ã‚„ã€ä½“ã¨åŒç³»è‰²ã®æœã¯é¿ã‘ã¦ãã ã•ã„ã€‚</li>
                </ul>
            </div>

            <button class="retry-btn" onclick="document.getElementById('manual-modal').style.display='none'">é–‰ã˜ã¦è¨ˆæ¸¬ã¸</button>
        </div>
    </div>

    <div class="ui-layer">
        <div id="start-screen">
            <h2 style="color:#fff; margin-bottom: 5px;">Rehab Analytics Pro</h2>
            <div style="color:#aaa; font-size:14px;">Reliable 2-Step Calibration System</div>
            
            <button id="start-btn" onclick="startCalibrationStep1()">æ¸¬å®šé–‹å§‹</button>
            <br>
            <button id="help-btn" onclick="document.getElementById('manual-modal').style.display='block'">èª¬æ˜æ›¸ã‚’è¦‹ã‚‹</button>
        </div>

        <div id="calibration-ui">
            <div class="calib-step" id="calib-step-label">STEP 1/2</div>
            <div class="calib-title" id="calib-title">ğŸ  ãƒ›ãƒ¼ãƒ ä½ç½®è¨­å®š</div>
            <div class="calib-desc" id="calib-desc">
                æ‰‹ã‚’<strong>ã€Œè†ã®ä¸Šã€</strong>ã‚„<strong>ã€Œæ‰‹å…ƒã€</strong>ã«ç½®ã„ã¦<br>
                ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãã ã•ã„ã€‚ï¼ˆ0%è¨­å®šï¼‰
            </div>
            <div class="calib-timer" id="calib-timer">5</div>
        </div>

        <div id="recording-ui">
            <div style="color:#ff3366; font-weight:bold; animation: blink 1s infinite;">â— RECORDING</div>
            <div class="timer" id="timer-val">10.0</div>
            
            <div class="realtime-box">
                <div class="rt-item">
                    <div class="rt-label">COUNT</div>
                    <div class="rt-val" id="rt-count">0</div>
                </div>
                <div class="rt-item">
                    <div class="rt-label">RANGE %</div>
                    <div class="rt-val"><span id="rt-percent">0</span><span class="rt-unit">%</span></div>
                </div>
                <div class="rt-item">
                    <div class="rt-label">SPEED</div>
                    <div class="rt-sub-val"><span id="rt-speed">0.0</span> <span style="font-size:10px">m/s</span></div>
                </div>
            </div>
            <div class="debug-state" id="debug-msg">State: Active</div>
        </div>

        <div id="result-ui">
            <h3 style="margin:0 0 15px 0; color:#00ffcc;">RESULT</h3>
            <div class="res-grid">
                <div class="res-box">
                    <div class="res-label">COUNT</div>
                    <div class="res-big" id="res-count">0</div>
                </div>
                <div class="res-box">
                    <div class="res-label">MAX REACH</div>
                    <div class="res-big"><span id="res-max-pct">0</span><span style="font-size:14px">%</span></div>
                </div>
                <div class="res-box">
                    <div class="res-label">MAX SPEED</div>
                    <div class="res-big"><span id="res-max-speed">0.0</span><span style="font-size:14px">m/s</span></div>
                </div>
                <div class="res-box">
                    <div class="res-label">TOTAL ENERGY</div>
                    <div class="res-big" id="res-energy">0.0</div>
                </div>
            </div>
            <button class="retry-btn" onclick="location.reload()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <canvas id="output_canvas"></canvas>
    <div class="graph-wrapper"><canvas id="chart_canvas"></canvas></div>

    <script>
        // --- è¨­å®š (Setting) ---
        let targetHand = 16; 
        let targetShoulder = 12;

        function setHand(side) {
            document.getElementById('btn-left').classList.remove('active');
            document.getElementById('btn-right').classList.remove('active');
            document.getElementById(`btn-${side}`).classList.add('active');
            if(side === 'left') { targetHand = 15; targetShoulder = 11; }
            else { targetHand = 16; targetShoulder = 12; }
            pathHistory = [];
        }

        // --- å¤‰æ•° (Variables) ---
        let appState = 'idle'; // idle, calib1, calib2, recording, result
        let lastTime = 0;
        let lastWrist = null;
        
        // â˜… 2æ®µéšã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ â˜…
        let calibMinDist = 0; // ãƒ›ãƒ¼ãƒ ä½ç½®(0%)
        let calibMaxDist = 0; // æœ€å¤§ãƒªãƒ¼ãƒ(100%)
        let calibRange = 1;   // å¯å‹•ç¯„å›² (Max - Min)

        // è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿
        let sessionData = { totalEnergy: 0, maxPercent: 0, maxSpeed: 0, moveCount: 0 };
        
        // ã‚«ã‚¦ãƒ³ãƒˆé–¾å€¤ (ç¯„å›²ãŒæ­£è¦åŒ–ã•ã‚ŒãŸã®ã§ã€æ˜ç¢ºãªï¼…ã§æŒ‡å®šå¯èƒ½)
        let isReaching = false; 
        const THRESHOLD_HIGH = 0.80; // 80%ã¾ã§ä¼¸ã³ãŸã‚‰ãƒªãƒ¼ãƒ
        const THRESHOLD_LOW = 0.20;  // 20%ã¾ã§æˆ»ã£ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆ

        // UI
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const debugMsg = document.getElementById('debug-msg');
        let pathHistory = [];

        // ã‚°ãƒ©ãƒ•è¨­å®š (0-120%)
        const ctxChart = document.getElementById('chart_canvas').getContext('2d');
        let chart = new Chart(ctxChart, {
            type: 'line',
            data: {
                labels: Array(60).fill(''),
                datasets: [{ 
                    data: Array(60).fill(0), 
                    borderColor: '#00ffcc', 
                    backgroundColor: 'rgba(0,255,204,0.1)', 
                    fill: true, tension: 0.3, pointRadius: 0 
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: { 
                    y: { display: true, min: 0, max: 120, grid: { color: '#333'} }, 
                    x: { display: false } 
                },
                plugins: { legend: { display: false } }
            }
        });

        // --- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ ---
        
        // STEP 1: ãƒ›ãƒ¼ãƒ ä½ç½® (Min)
        function startCalibrationStep1() {
            appState = 'calib1';
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('calibration-ui').style.display = 'block';
            
            // UIæ›´æ–°
            document.getElementById('calib-step-label').innerText = "STEP 1/2";
            document.getElementById('calib-title').innerText = "ğŸ  ãƒ›ãƒ¼ãƒ ä½ç½®è¨­å®š";
            document.getElementById('calib-desc').innerHTML = "æ‰‹ã‚’<strong>ã€Œè†ã®ä¸Šã€</strong>ã‚„<strong>ã€Œæ‰‹å…ƒã€</strong>ã«ç½®ã„ã¦<br>ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãã ã•ã„ã€‚(0%)";
            document.getElementById('calib-title').style.color = "#00ffcc";

            calibMinDist = 10.0; // åˆæœŸåŒ–ï¼ˆå¤§ããªå€¤ï¼‰
            let count = 5;
            document.getElementById('calib-timer').innerText = count;

            const cTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('calib-timer').innerText = count;
                } else {
                    clearInterval(cTimer);
                    startCalibrationStep2();
                }
            }, 1000);
        }

        // STEP 2: æœ€å¤§ãƒªãƒ¼ãƒ (Max)
        function startCalibrationStep2() {
            appState = 'calib2';
            
            // UIæ›´æ–°
            document.getElementById('calib-step-label').innerText = "STEP 2/2";
            document.getElementById('calib-title').innerText = "ğŸ“ æœ€å¤§ãƒªãƒ¼ãƒè¨­å®š";
            document.getElementById('calib-desc').innerHTML = "è…•ã‚’<strong>ã€Œé™ç•Œã¾ã§ã€</strong>é ãã«<br>ä¼¸ã°ã—ã¦ãã ã•ã„ï¼(100%)";
            document.getElementById('calib-title').style.color = "#ffcc00";

            calibMaxDist = 0; // åˆæœŸåŒ–
            let count = 5;
            document.getElementById('calib-timer').innerText = count;

            const cTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('calib-timer').innerText = count;
                } else {
                    clearInterval(cTimer);
                    
                    // ç¯„å›²è¨ˆç®—ã¨ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                    calibRange = calibMaxDist - calibMinDist;
                    if (calibRange < 0.1) calibRange = 0.3; // å·®ãŒå°ã•ã™ãã‚‹å ´åˆã®å®‰å…¨ç­–
                    
                    document.getElementById('calibration-ui').style.display = 'none';
                    startMeasurement();
                }
            }, 1000);
        }

        // STEP 3: è¨ˆæ¸¬é–‹å§‹
        function startMeasurement() {
            appState = 'recording';
            document.getElementById('recording-ui').style.display = 'block';
            sessionData = { totalEnergy: 0, maxPercent: 0, maxSpeed: 0, moveCount: 0 };
            isReaching = false;

            let timeLeft = 10.0;
            const timer = setInterval(() => {
                timeLeft -= 0.1;
                if(timeLeft < 0) timeLeft = 0;
                document.getElementById('timer-val').innerText = timeLeft.toFixed(1);
                
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    finishMeasurement();
                }
            }, 100);
        }

        function finishMeasurement() {
            appState = 'result';
            document.getElementById('recording-ui').style.display = 'none';
            document.getElementById('result-ui').style.display = 'block';
            
            document.getElementById('res-count').innerText = sessionData.moveCount;
            document.getElementById('res-max-pct').innerText = sessionData.maxPercent.toFixed(0);
            document.getElementById('res-max-speed').innerText = sessionData.maxSpeed.toFixed(2);
            document.getElementById('res-energy').innerText = sessionData.totalEnergy.toFixed(1);
        }

        // --- MediaPipe å‡¦ç† ---
        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseWorldLandmarks && results.poseWorldLandmarks[targetHand]) {
                const hand3D = results.poseWorldLandmarks[targetHand];
                const shoulder3D = results.poseWorldLandmarks[targetShoulder];
                const hand2D = results.poseLandmarks[targetHand];
                const shoulder2D = results.poseLandmarks[targetShoulder];

                if (hand3D && shoulder3D) {
                    // è·é›¢è¨ˆç®— (çµ¶å¯¾è·é›¢)
                    const dist = Math.sqrt(
                        Math.pow(hand3D.x - shoulder3D.x, 2) +
                        Math.pow(hand3D.y - shoulder3D.y, 2) +
                        Math.pow(hand3D.z - shoulder3D.z, 2)
                    );

                    // --- çŠ¶æ…‹ã”ã¨ã®å‡¦ç† ---

                    // 1. ãƒ›ãƒ¼ãƒ ä½ç½®è¨ˆæ¸¬ (æœ€å°å€¤ã‚’æ¢ã™)
                    if (appState === 'calib1') {
                        // å®‰å®šã•ã›ã‚‹ãŸã‚ã€æœŸé–“ä¸­ã®å¹³å‡ã‚’å–ã‚ŠãŸã„ãŒã€ç°¡æ˜“çš„ã«ã€Œæœ€å¾Œã«è¿‘ã„å€¤ã€ã‚’æ¡ç”¨
                        // ã“ã“ã§ã¯ã€ŒæœŸé–“ä¸­ã®æœ€å°å€¤ã€ã§ã¯ãªãã€Œç¾åœ¨ã®å€¤ã€ã‚’æ›´æ–°ã—ç¶šã‘ã‚‹ï¼ˆãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã„ã‚‹ã®ã§ï¼‰
                        calibMinDist = dist; 
                    }
                    
                    // 2. æœ€å¤§ãƒªãƒ¼ãƒè¨ˆæ¸¬ (æœ€å¤§å€¤ã‚’æ¢ã™)
                    else if (appState === 'calib2') {
                        if (dist > calibMaxDist) calibMaxDist = dist;
                    }

                    // 3. æœ¬ç•ªè¨ˆæ¸¬
                    else if (appState === 'recording') {
                        // â˜…æ ¸å¿ƒãƒ­ã‚¸ãƒƒã‚¯: ç¯„å›²ã«å¯¾ã™ã‚‹å‰²åˆã‚’è¨ˆç®—
                        // (ç¾åœ¨å€¤ - æœ€å°å€¤) / (æœ€å¤§å€¤ - æœ€å°å€¤)
                        let rawRatio = (dist - calibMinDist) / calibRange;
                        
                        // å¤–ã‚Œå€¤è£œæ­£ (0%ä»¥ä¸‹ã‚„120%ä»¥ä¸Šã¯ä¸¸ã‚ã‚‹)
                        if (rawRatio < 0) rawRatio = 0;
                        if (rawRatio > 1.2) rawRatio = 1.2;

                        const percent = rawRatio * 100;

                        // UI & Graph
                        document.getElementById('rt-percent').innerText = percent.toFixed(0);
                        const data = chart.data.datasets[0].data;
                        data.shift(); data.push(percent); chart.update();

                        if(percent > sessionData.maxPercent) sessionData.maxPercent = percent;

                        // â˜… ã‚«ã‚¦ãƒ³ãƒˆåˆ¤å®š (æ­£è¦åŒ–ã•ã‚ŒãŸï¼…ã§åˆ¤å®šã™ã‚‹ã®ã§ç¢ºå®Ÿ)
                        if (!isReaching && rawRatio > THRESHOLD_HIGH) { // 80%è¶…ãˆ
                            isReaching = true;
                            debugMsg.innerText = "Reaching (>80%)";
                        } else if (isReaching && rawRatio < THRESHOLD_LOW) { // 20%æœªæº€
                            isReaching = false;
                            sessionData.moveCount++;
                            document.getElementById('rt-count').innerText = sessionData.moveCount;
                            debugMsg.innerText = "Return (<20%) -> Count!";
                        }

                        // Speed & Energy
                        const currentTime = Date.now();
                        if (lastWrist && lastTime > 0) {
                            const dt = (currentTime - lastTime) / 1000; 
                            if (dt > 0) {
                                const moveDist = Math.sqrt(
                                    Math.pow(hand3D.x - lastWrist.x, 2) +
                                    Math.pow(hand3D.y - lastWrist.y, 2) +
                                    Math.pow(hand3D.z - lastWrist.z, 2)
                                );
                                let speed = moveDist / dt; 
                                if (speed < 20) {
                                    sessionData.totalEnergy += (0.5 * speed * speed);
                                    if(speed > sessionData.maxSpeed) sessionData.maxSpeed = speed;
                                    document.getElementById('rt-speed').innerText = speed.toFixed(1);
                                }
                            }
                        }
                    }

                    // æç”»
                    const px = hand2D.x * canvasElement.width;
                    const py = hand2D.y * canvasElement.height;
                    const sx = shoulder2D.x * canvasElement.width;
                    const sy = shoulder2D.y * canvasElement.height;

                    drawMarker(sx, sy, "#00FFFF", "Shoulder"); 
                    drawMarker(px, py, isReaching ? "#FF3366" : "#00FFFF", "Hand");

                    lastWrist = hand3D;
                    lastTime = Date.now();
                }
            }
        }

        function drawMarker(x, y, color, label) {
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 12, 0, 2 * Math.PI);
            canvasCtx.fillStyle = color;
            canvasCtx.fill();
            canvasCtx.strokeStyle = "#fff";
            canvasCtx.lineWidth = 3;
            canvasCtx.stroke();
            if(label) {
                canvasCtx.fillStyle = "#fff";
                canvasCtx.font = "bold 12px Arial";
                canvasCtx.fillText(label, x + 18, y + 4);
            }
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true });
        pose.onResults(onResults);
        
        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>