<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rehab-Vis 3D Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: "Helvetica Neue", Arial, sans-serif; }
        
        /* ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° */
        #debug-log { display: none; }

        /* èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        canvas#output_canvas { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            object-fit: cover; transform: scaleX(-1); z-index: 1;
        }
        .graph-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0; height: 25vh;
            background: rgba(0, 0, 0, 0.85); border-top: 1px solid #444;
            padding: 10px; box-sizing: border-box; z-index: 10;
        }
        #chart_canvas { width: 100%; height: 100%; }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* å·¦å³ã‚¹ã‚¤ãƒƒãƒ */
        .hand-switch-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 6000; pointer-events: auto;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 30px;
            display: flex; gap: 10px; border: 1px solid #666;
        }
        .hand-btn {
            background: transparent; border: none; color: #ccc;
            padding: 8px 16px; font-weight: bold; cursor: pointer; border-radius: 20px; font-size: 14px;
        }
        .hand-btn.active { background: #00ffcc; color: #000; box-shadow: 0 0 8px #00ffcc; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            pointer-events: auto; text-align: center;
            background: rgba(0, 0, 0, 0.85); padding: 30px; border-radius: 20px;
            border: 1px solid #555; backdrop-filter: blur(5px);
            width: 85%; max-width: 350px;
        }
        .app-title { color: #fff; font-size: 20px; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        #start-btn {
            background: linear-gradient(135deg, #00ffcc, #00ccaa); color: #000;
            border: none; padding: 15px 0; width: 100%; font-size: 20px; font-weight: bold;
            border-radius: 50px; cursor: pointer; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 255, 204, 0.4);
        }
        #help-btn {
            background: #444; color: #fff; border: 1px solid #777;
            padding: 10px 0; width: 100%; border-radius: 50px; cursor: pointer; font-size: 14px;
        }

        /* èª¬æ˜æ›¸ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #manual-modal {
            display: none; pointer-events: auto; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .manual-content {
            background: #1a1a1a; margin: 20px auto; padding: 25px; width: 85%; max-width: 600px;
            border-radius: 15px; border: 1px solid #444; color: #eee; padding-bottom: 50px;
        }
        .manual-title { font-size: 22px; color: #00ffcc; border-bottom: 2px solid #00ffcc; padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; }
        .manual-sec { margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .manual-h3 { font-size: 18px; color: #fff; font-weight: bold; margin-bottom: 8px; border-left: 4px solid #00ffcc; padding-left: 10px; }
        .manual-p { font-size: 14px; line-height: 1.8; color: #ccc; margin-left: 10px; }
        .manual-list { font-size: 14px; line-height: 1.8; color: #ccc; margin-left: 20px; }
        .manual-highlight { color: #ffcc00; font-weight: bold; }
        .close-manual {
            background: #00ffcc; color: #000; border: none; padding: 12px 40px;
            font-weight: bold; border-radius: 30px; cursor: pointer; display: block; margin: 30px auto; font-size: 16px;
        }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ & è¨ˆæ¸¬ä¸­ */
        #countdown-ui, #recording-ui { display: none; pointer-events: none; text-align: center; }
        .countdown-num { font-size: 100px; color: #00ffcc; font-weight: bold; text-shadow: 0 0 20px black; }
        .timer { font-size: 80px; color: #fff; font-weight: bold; }
        .rec-label { color: #ff3366; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* çµæœç”»é¢ */
        #result-ui {
            display: none; pointer-events: auto; background: rgba(15, 15, 15, 0.98);
            padding: 20px; border-radius: 15px; border: 2px solid #00ffcc;
            width: 90%; max-width: 400px; color: #fff;
        }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .res-item { background: #222; padding: 10px; border-radius: 10px; text-align: center; }
        .res-label { font-size: 11px; color: #aaa; margin-bottom: 5px; text-transform: uppercase; }
        .res-val { font-size: 22px; font-weight: bold; color: #fff; }
        .res-unit { font-size: 11px; color: #888; }
        
        .main-score-box { text-align: center; padding-bottom: 15px; border-bottom: 1px solid #444; }
        .main-score-val { font-size: 50px; font-weight: bold; color: #00ffcc; }
        
        .retry-btn { background: #444; color: #fff; width: 100%; padding: 12px; border-radius: 30px; border: none; cursor: pointer; font-size: 16px; }

    </style>
</head>
<body>
    <video id="input_video" style="display:none" autoplay playsinline></video>

    <div class="hand-switch-container">
        <button class="hand-btn" id="btn-left" onclick="setHand('left')">å·¦è…• (Left)</button>
        <button class="hand-btn active" id="btn-right" onclick="setHand('right')">å³è…• (Right)</button>
    </div>

    <div id="manual-modal">
        <div class="manual-content">
            <div class="manual-title">ğŸ“˜ ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹ã¨è§£èª¬</div>
            
            <div class="manual-sec">
                <div class="manual-h3">1. ã‚¢ãƒ—ãƒªã®ç‰¹å¾´ (Merit)</div>
                <div class="manual-p">
                    ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã‚’ä½¿ã£ã¦ã‚ãªãŸã®å‹•ãã‚’è§£æã—ã¾ã™ã€‚<br>
                    æœ€å¤§ã®ç‰¹å¾´ã¯<strong>ã€Œå¥¥è¡Œãï¼ˆæ‰‹å‰ãƒ»å¥¥ï¼‰ã€ã®å‹•ãã‚‚è¨ˆç®—ã§ãã‚‹ã“ã¨</strong>ã§ã™ã€‚æ™®é€šã®ãƒ“ãƒ‡ã‚ªéŒ²ç”»ã¨ã¯é•ã„ã€AIãŒç©ºé–“ã‚’èªè­˜ã™ã‚‹ãŸã‚ã€ãƒªãƒ¼ãƒå‹•ä½œãªã©ã®ç«‹ä½“çš„ãªé‹å‹•é‡ã‚’æ¸¬ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
                </div>
            </div>

            <div class="manual-sec">
                <div class="manual-h3">2. è¨ˆæ¸¬çµæœã®è¦‹æ–¹</div>
                <div class="manual-p">
                    è¨ˆæ¸¬å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹4ã¤ã®æ•°å­—ã®æ„å‘³ã§ã™ã€‚
                </div>
                <ul class="manual-list">
                    <li><strong>MAX SPEED (ç¬ç™ºåŠ›):</strong><br>å‹•ãå‡ºã—ã®é€Ÿã•ã§ã™ã€‚ã€Œéº»ç—ºå´ã®å‹•ãå‡ºã—ãŒé…ã‚Œã¦ã„ãªã„ã‹ï¼Ÿã€ã€Œå¥å´ã¨åŒã˜é€Ÿåº¦ãŒå‡ºã›ã‚‹ã‹ï¼Ÿã€ã®ãƒã‚§ãƒƒã‚¯ã«ä½¿ã„ã¾ã™ã€‚</li>
                    <li><strong>DISTANCE (ç§»å‹•è·é›¢):</strong><br>æ‰‹ãŒå‹•ã„ãŸåˆè¨ˆã®è·é›¢ã§ã™ã€‚åŒã˜10ç§’é–“ã§ã‚‚ã€ã“ã®æ•°å€¤ãŒå¤§ãã„ã»ã©ã€Œä¼‘ã¿ãªãå‹•ã‘ãŸï¼ˆæŒä¹…åŠ›ãƒ»åå¾©æ€§ãŒã‚ã‚‹ï¼‰ã€ã“ã¨ã«ãªã‚Šã¾ã™ã€‚</li>
                    <li><strong>ACTIVITY (å›æ•°):</strong><br>ã€Œè¡Œã£ã¦æˆ»ã‚‹ã€ãªã©ã®å‹•ä½œãŒä½•å›ã§ããŸã‹ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚</li>
                    <li><strong>TOTAL WORK (ç·é‹å‹•é‡):</strong><br>é‹å‹•ã®ã€Œå¼·ã•ã€ã¨ã€Œé‡ã€ã®åˆè¨ˆã‚¹ã‚³ã‚¢ã§ã™ã€‚</li>
                </ul>
            </div>

            <div class="manual-sec">
                <div class="manual-h3">3. ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç®—å‡ºæ–¹æ³•</div>
                <div class="manual-p">
                    ç‰©ç†ã®å…¬å¼ï¼ˆé‹å‹•ã‚¨ãƒãƒ«ã‚®ãƒ¼ $K = 1/2mv^2$ï¼‰ã‚’å¿œç”¨ã—ã¦ã„ã¾ã™ã€‚<br>
                    ã‚«ãƒ¡ãƒ©ã‹ã‚‰å¾—ã‚‰ã‚ŒãŸã€Œæ‰‹ã®é€Ÿã•ã€ã‚’ç©ã¿ä¸Šã’ã‚‹ã“ã¨ã§ã€ã©ã‚Œãã‚‰ã„è…•ãŒä»•äº‹ã‚’ã—ãŸã‹ã‚’æ¨å®šã—ã¦ã„ã¾ã™ã€‚<br>
                    â€»è…•ã®é‡ã•ã¯å…¨å“¡ä¸€å¾‹ã¨ã—ã¦è¨ˆç®—ã—ã¦ã„ã‚‹ãŸã‚ã€ä»–äººã¨ã®æ¯”è¼ƒã§ã¯ãªã<strong>ã€Œè‡ªåˆ†ã®å·¦å³å·®ã€</strong>ã‚„<strong>ã€Œéå»ã®è‡ªåˆ†ã€</strong>ã¨ã®æ¯”è¼ƒã«ä½¿ã£ã¦ãã ã•ã„ã€‚
                </div>
            </div>

            <div class="manual-sec">
                <div class="manual-h3">âš ï¸ ã‚¢ãƒ—ãƒªã®é™ç•Œãƒ»æ³¨æ„ç‚¹</div>
                <div class="manual-p">
                    ã“ã®ã‚¢ãƒ—ãƒªã¯ç°¡æ˜“æ¸¬å®šãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€åŒ»ç™‚æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ç‰¹æ€§ã‚’ç†è§£ã—ã¦ã”ä½¿ç”¨ãã ã•ã„ã€‚
                </div>
                <ul class="manual-list">
                    <li><span class="manual-highlight">ã‚¹ãƒãƒ›ã®æ€§èƒ½ã«ä¾å­˜ã—ã¾ã™:</span><br>å¤ã„æ©Ÿç¨®ã‚„ãƒãƒƒãƒ†ãƒªãƒ¼ä½ä¸‹æ™‚ã¯ã€å‡¦ç†ãŒé…ã‚Œã€æ•°å€¤ãŒä½ãå‡ºã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
                    <li><span class="manual-highlight">æŒ‡å…ˆã¯è¦‹ã¦ã„ã¾ã›ã‚“:</span><br>ã€Œæ‰‹é¦–ã€ã®ä½ç½®ã‚’è¿½è·¡ã—ã¦ã„ã¾ã™ã€‚æŒ‡å…ˆã®ç´°ã‹ã„å‹•ãï¼ˆã¤ã¾ã‚€ç­‰ï¼‰ã¯ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«å«ã¾ã‚Œã¾ã›ã‚“ã€‚</li>
                    <li><span class="manual-highlight">å¥¥è¡Œãã¯ã€Œæ¨å®šå€¤ã€ã§ã™:</span><br>AIãŒç”»åƒã‹ã‚‰æ¨æ¸¬ã—ãŸè·é›¢ã§ã™ã€‚å®Ÿéš›ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ã§æ¸¬ã£ãŸè·é›¢ã¨ã¯èª¤å·®ãŒç”Ÿã˜ã¾ã™ï¼ˆå·¦å³ã®æ¯”è¼ƒã«ã¯ååˆ†ä½¿ãˆã¾ã™ï¼‰ã€‚</li>
                </ul>
            </div>

            <button class="close-manual" onclick="toggleManual(false)">é–‰ã˜ã¦è¨ˆæ¸¬ã¸</button>
        </div>
    </div>

    <div class="ui-layer">
        <div id="start-screen">
            <div class="app-title">Upper Limb Analytics<br><span style="font-size:12px; color:#aaa">Supervised by OT</span></div>
            <button id="start-btn" onclick="startSequence()">è¨ˆæ¸¬ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button id="help-btn" onclick="toggleManual(true)">ä½¿ã„æ–¹ãƒ»èª¬æ˜æ›¸</button>
        </div>

        <div id="countdown-ui">
            <div class="countdown-num" id="count-val">3</div>
        </div>
        
        <div id="recording-ui">
            <div class="rec-label">â— RECORDING</div>
            <div class="timer" id="timer-val">10.0</div>
        </div>

        <div id="result-ui">
            <div class="main-score-box">
                <div class="res-label">TOTAL WORK (ç·é‹å‹•ã‚¨ãƒãƒ«ã‚®ãƒ¼)</div>
                <div class="main-score-val" id="res-total">0.0</div>
            </div>
            
            <div class="res-grid">
                <div class="res-item">
                    <div class="res-label">MAX SPEED (ç¬ç™ºåŠ›)</div>
                    <div class="res-val" id="res-max-speed">0.0</div>
                    <div class="res-unit">m/s</div>
                </div>
                <div class="res-item">
                    <div class="res-label">DISTANCE (è·é›¢)</div>
                    <div class="res-val" id="res-dist">0.0</div>
                    <div class="res-unit">meters</div>
                </div>
                <div class="res-item">
                    <div class="res-label">ACTIVITY (å›æ•°)</div>
                    <div class="res-val" id="res-count">0</div>
                    <div class="res-unit">reps</div>
                </div>
                <div class="res-item">
                    <div class="res-label">QUALITY</div>
                    <div class="res-val" style="font-size:16px" id="res-comment">-</div>
                    <div class="res-unit">feedback</div>
                </div>
            </div>
            
            <button class="retry-btn" onclick="resetApp()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <canvas id="output_canvas"></canvas>
    <div class="graph-wrapper"><canvas id="chart_canvas"></canvas></div>

    <script>
        // --- è¨­å®š ---
        let targetIndex = 16; 
        
        function toggleManual(show) {
            document.getElementById('manual-modal').style.display = show ? 'block' : 'none';
        }

        function setHand(side) {
            document.getElementById('btn-left').classList.remove('active');
            document.getElementById('btn-right').classList.remove('active');
            document.getElementById(`btn-${side}`).classList.add('active');
            targetIndex = (side === 'left') ? 15 : 16;
            resetApp();
        }

        // --- å¤‰æ•° ---
        let isRecording = false;
        let timerInterval = null;
        let lastTime = 0;
        let lastWrist = null;
        let pathHistory = [];

        // è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿
        let sessionData = {
            totalEnergy: 0,
            maxSpeed: 0,
            totalDistance: 0,
            moveCount: 0
        };
        let isMoving = false; // å‹•ä½œã‚«ã‚¦ãƒ³ãƒˆç”¨ãƒ•ãƒ©ã‚°

        // UI
        const startScreen = document.getElementById('start-screen');
        const countdownUI = document.getElementById('countdown-ui');
        const countVal = document.getElementById('count-val');
        const recUI = document.getElementById('recording-ui');
        const resUI = document.getElementById('result-ui');
        const timerDisplay = document.getElementById('timer-val');
        
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const videoElement = document.getElementById('input_video');

        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // Chart
        let energyChart = null;
        try {
            const ctxChart = document.getElementById('chart_canvas').getContext('2d');
            energyChart = new Chart(ctxChart, {
                type: 'line',
                data: {
                    labels: Array(50).fill(''),
                    datasets: [{ data: Array(50).fill(0), borderColor: '#00ffcc', backgroundColor: 'rgba(0, 255, 204, 0.2)', borderWidth: 2, tension: 0.3, fill: true, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { display: false, suggestedMax: 10 }, x: { display: false } }, plugins: { legend: { display: false } } }
            });
        } catch(e) {}

        // --- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ ---
        function startSequence() {
            startScreen.style.display = 'none';
            countdownUI.style.display = 'block';
            let count = 3;
            countVal.innerText = count;

            const cInterval = setInterval(() => {
                count--;
                if(count > 0) {
                    countVal.innerText = count;
                } else {
                    clearInterval(cInterval);
                    countdownUI.style.display = 'none';
                    startMeasurement();
                }
            }, 1000);
        }

        function startMeasurement() {
            isRecording = true;
            // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
            sessionData = { totalEnergy: 0, maxSpeed: 0, totalDistance: 0, moveCount: 0 };
            isMoving = false;
            
            let timeLeft = 10.0;
            recUI.style.display = 'block';
            
            pathHistory = [];
            if(energyChart) { energyChart.data.datasets[0].data = Array(50).fill(0); energyChart.update(); }

            timerInterval = setInterval(() => {
                timeLeft -= 0.1;
                if(timeLeft < 0) timeLeft = 0;
                timerDisplay.innerText = timeLeft.toFixed(1);
                
                if(timeLeft <= 0) stopMeasurement();
            }, 100);
        }

        function stopMeasurement() {
            isRecording = false;
            clearInterval(timerInterval);
            recUI.style.display = 'none';
            showResult();
        }

        function showResult() {
            resUI.style.display = 'block';
            
            // æ•°å€¤ã®åæ˜ 
            document.getElementById('res-total').innerText = sessionData.totalEnergy.toFixed(1);
            document.getElementById('res-max-speed').innerText = sessionData.maxSpeed.toFixed(2);
            document.getElementById('res-dist').innerText = sessionData.totalDistance.toFixed(2);
            document.getElementById('res-count').innerText = sessionData.moveCount;

            // ç°¡æ˜“ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
            let comment = "Good Effort!";
            if(sessionData.maxSpeed > 2.0) comment = "Dynamic Speed!";
            else if(sessionData.totalDistance > 5.0) comment = "Great Endurance!";
            else if(sessionData.moveCount > 5) comment = "Nice Reps!";
            else if(sessionData.totalEnergy < 10) comment = "Keep Going!";
            
            document.getElementById('res-comment').innerText = comment;
        }

        function resetApp() {
            resUI.style.display = 'none';
            startScreen.style.display = 'block';
            pathHistory = [];
            if(energyChart) { energyChart.data.datasets[0].data = Array(50).fill(0); energyChart.update(); }
        }

        // --- MediaPipe ---
        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseWorldLandmarks && results.poseWorldLandmarks[targetIndex]) {
                const wristWorld = results.poseWorldLandmarks[targetIndex];
                const wristScreen = results.poseLandmarks[targetIndex];
                const currentTime = Date.now();
                let currentEnergy = 0;
                let velocity = 0;

                if (lastWrist && lastTime > 0) {
                    const deltaTime = (currentTime - lastTime) / 1000;
                    if (deltaTime > 0) {
                        const dist = Math.sqrt(
                            Math.pow(wristWorld.x - lastWrist.x, 2) +
                            Math.pow(wristWorld.y - lastWrist.y, 2) +
                            Math.pow(wristWorld.z - lastWrist.z, 2)
                        );
                        velocity = dist / deltaTime;
                        
                        // ãƒã‚¤ã‚ºé™¤å»ã—ã¤ã¤è¨ˆç®—
                        if(velocity < 15) {
                            currentEnergy = 0.5 * Math.pow(velocity, 2);
                            
                            // â˜…è¨ˆæ¸¬ä¸­ã®ã¿é›†è¨ˆ
                            if(isRecording) {
                                sessionData.totalEnergy += currentEnergy;
                                sessionData.totalDistance += dist;
                                if(velocity > sessionData.maxSpeed) sessionData.maxSpeed = velocity;

                                // å‹•ä½œã‚«ã‚¦ãƒ³ãƒˆ (ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯: ä¸€å®šé€Ÿåº¦ã‚’è¶…ãˆãŸã‚‰ã€Œå‹•ãå§‹ã‚ã€)
                                if(velocity > 0.5 && !isMoving) {
                                    isMoving = true;
                                    sessionData.moveCount++;
                                } else if(velocity < 0.2) {
                                    isMoving = false;
                                }
                            }
                        }
                    }
                }

                if(energyChart) {
                    const data = energyChart.data.datasets[0].data;
                    data.shift(); data.push(currentEnergy);
                    energyChart.update();
                }

                const px = wristScreen.x * canvasElement.width;
                const py = wristScreen.y * canvasElement.height;
                pathHistory.unshift({ x: px, y: py, energy: currentEnergy });
                if (pathHistory.length > 20) pathHistory.pop();

                if (pathHistory.length > 1) {
                    canvasCtx.lineWidth = 5; canvasCtx.lineCap = 'round';
                    for (let i = 0; i < pathHistory.length - 1; i++) {
                        const pt1 = pathHistory[i]; const pt2 = pathHistory[i+1];
                        canvasCtx.beginPath(); canvasCtx.moveTo(pt1.x, pt1.y); canvasCtx.lineTo(pt2.x, pt2.y);
                        const intensity = Math.min(pt1.energy / 5.0, 1.0);
                        const r = Math.floor(255 * intensity); const b = Math.floor(255 * (1 - intensity));
                        canvasCtx.strokeStyle = `rgba(${r}, 100, ${b}, ${1 - i/20})`;
                        canvasCtx.stroke();
                    }
                }
                
                canvasCtx.beginPath(); canvasCtx.arc(px, py, 10, 0, 2 * Math.PI);
                canvasCtx.fillStyle = "#fff"; canvasCtx.fill();

                lastWrist = wristWorld;
                lastTime = currentTime;
            }
            canvasCtx.restore();
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);
        const camera = new Camera(videoElement, { onFrame: async () => { await pose.send({image: videoElement}); }, width: 640, height: 480 });
        camera.start();
    </script>
</body>
</html>