<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rehab-Vis Hybrid</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- デザイン設定 --- */
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        
        canvas#output_canvas { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            object-fit: cover; transform: scaleX(-1); z-index: 1;
        }
        .graph-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0; height: 25vh;
            background: rgba(0, 0, 0, 0.85); border-top: 1px solid #444; z-index: 10;
        }
        #chart_canvas { width: 100%; height: 100%; }

        /* UIレイヤー */
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .hand-switch-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 6000; pointer-events: auto;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 30px;
            display: flex; gap: 10px; border: 1px solid #666;
        }
        .hand-btn {
            background: transparent; border: none; color: #ccc;
            padding: 8px 16px; font-weight: bold; cursor: pointer; border-radius: 20px;
        }
        .hand-btn.active { background: #00ffcc; color: #000; }

        /* マニュアル */
        #help-btn {
            position: absolute; top: 10px; right: 10px;
            background: #444; color: #fff; border: 1px solid #777;
            padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 12px;
        }
        #manual-modal {
            display: none; pointer-events: auto; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; overflow-y: auto;
        }
        .manual-content {
            background: #1a1a1a; margin: 20px auto; padding: 25px; width: 85%; max-width: 500px;
            border-radius: 15px; border: 1px solid #444; color: #eee; text-align: left;
        }
        .manual-highlight { color: #ffcc00; font-weight: bold; }

        /* スタート画面 */
        #start-screen {
            pointer-events: auto; text-align: center;
            background: rgba(0,0,0,0.8); padding: 30px; border-radius: 20px; border: 1px solid #555;
            position: relative;
        }
        #start-btn {
            background: linear-gradient(135deg, #00ffcc, #0099aa);
            border: none; padding: 15px 40px; font-size: 20px; 
            font-weight: bold; border-radius: 50px; cursor: pointer; margin-top: 20px;
            color: #000; box-shadow: 0 0 15px rgba(0,255,204,0.3);
        }

        /* カウントダウン */
        #countdown-ui { display: none; }
        .countdown-num { font-size: 120px; color: #00ffcc; font-weight: bold; text-shadow: 0 0 20px #000; }
        .guide-msg { font-size: 18px; color: #fff; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px;}

        /* 計測中 */
        #recording-ui { display: none; text-align: center; width: 100%; }
        .timer { font-size: 80px; color: #fff; font-weight: bold; line-height: 1; }
        .realtime-box { 
            display: flex; justify-content: center; gap: 20px; margin-top: 10px; 
            background: rgba(0,0,0,0.5); padding: 10px;
        }
        .rt-item { text-align: center; }
        .rt-label { font-size: 10px; color: #aaa; }
        .rt-val { font-size: 24px; font-weight: bold; color: #00ffcc; }

        /* 結果画面 */
        #result-ui {
            display: none; pointer-events: auto; background: rgba(15,15,15,0.98);
            padding: 20px; border-radius: 15px; border: 2px solid #00ffcc;
            width: 320px; color: #fff; text-align: center;
        }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .res-box { background: #222; padding: 10px; border-radius: 8px; }
        .res-big { font-size: 28px; font-weight: bold; color: #fff; }
        .retry-btn { background: #444; color: #fff; padding: 12px 30px; border-radius: 30px; border: none; cursor: pointer; font-size: 16px; margin-top: 10px; }
    </style>
</head>
<body>
    <video id="input_video" style="display:none" autoplay playsinline></video>

    <div class="hand-switch-container">
        <button class="hand-btn" id="btn-left" onclick="setHand('left')">左腕 (Left)</button>
        <button class="hand-btn active" id="btn-right" onclick="setHand('right')">右腕 (Right)</button>
    </div>

    <div id="manual-modal">
        <div class="manual-content">
            <h3 style="color:#00ffcc; border-bottom:1px solid #444; padding-bottom:10px;">使い方ガイド</h3>
            
            <p><strong>1. 横を向いて座りましょう</strong><br>
            カメラに対して<span class="manual-highlight">「真横」</span>を向くと、リーチの距離が最も正確に測れます。</p>
            
            <p><strong>2. 開始位置で静止します</strong><br>
            カウントダウン（3, 2, 1）の間は、手を膝の上などの<span class="manual-highlight">「スタート位置」</span>に置いて止まってください。そこが「0地点」になります。</p>

            <p><strong>3. 大きく動かしましょう</strong><br>
            スタート位置から<span class="manual-highlight">20cm以上</span>手を伸ばすと「リーチ」と判定され、元の位置に戻すと「1回」とカウントされます。</p>

            <p><strong>4. 指標について</strong><br>
            ・REACH: 肩から手までの距離<br>
            ・ENERGY: 動きの速さと強さ<br>
            ・COUNT: 往復回数</p>

            <button class="retry-btn" onclick="document.getElementById('manual-modal').style.display='none'">閉じる</button>
        </div>
    </div>

    <div class="ui-layer">
        <div id="start-screen">
            <button id="help-btn" onclick="document.getElementById('manual-modal').style.display='block'">?</button>
            <h2 style="color:#fff; margin-bottom: 5px;">Rehab Analytics</h2>
            <div style="color:#888; font-size:12px;">Hybrid Measure: Energy & Reach</div>
            <button id="start-btn" onclick="startSequence()">計測開始</button>
        </div>

        <div id="countdown-ui">
            <div class="guide-msg">スタート位置で静止してください...</div>
            <div class="countdown-num" id="count-val">3</div>
        </div>

        <div id="recording-ui">
            <div style="color:#ff3366; font-weight:bold; animation: blink 1s infinite;">● RECORDING</div>
            <div class="timer" id="timer-val">10.0</div>
            
            <div class="realtime-box">
                <div class="rt-item">
                    <div class="rt-label">COUNT</div>
                    <div class="rt-val" id="rt-count">0</div>
                </div>
                <div class="rt-item">
                    <div class="rt-label">SPEED</div>
                    <div class="rt-val"><span id="rt-speed">0.0</span> <span style="font-size:10px">m/s</span></div>
                </div>
                <div class="rt-item">
                    <div class="rt-label">REACH</div>
                    <div class="rt-val"><span id="rt-reach">0.0</span> <span style="font-size:10px">m</span></div>
                </div>
            </div>
        </div>

        <div id="result-ui">
            <h3 style="margin:0 0 15px 0; color:#00ffcc;">RESULT</h3>
            
            <div style="margin-bottom: 20px;">
                <div style="font-size:12px; color:#aaa;">TOTAL ENERGY (運動量)</div>
                <div style="font-size:40px; font-weight:bold; color:#00ffcc;" id="res-energy">0.0</div>
            </div>

            <div class="res-grid">
                <div class="res-box">
                    <div style="font-size:10px; color:#aaa;">COUNT</div>
                    <div class="res-big" id="res-count">0</div>
                </div>
                <div class="res-box">
                    <div style="font-size:10px; color:#aaa;">MAX SPEED</div>
                    <div class="res-big" id="res-speed">0.0</div>
                </div>
                <div class="res-box">
                    <div style="font-size:10px; color:#aaa;">MAX REACH</div>
                    <div class="res-big" id="res-reach">0.0</div>
                </div>
                <div class="res-box">
                    <div style="font-size:10px; color:#aaa;">DISTANCE</div>
                    <div class="res-big" id="res-dist">0.0</div>
                </div>
            </div>
            
            <button class="retry-btn" onclick="location.reload()">ホームに戻る</button>
        </div>
    </div>

    <canvas id="output_canvas"></canvas>
    <div class="graph-wrapper"><canvas id="chart_canvas"></canvas></div>

    <script>
        // --- 設定 (Setting) ---
        let targetHand = 16; 
        let targetShoulder = 12;

        function setHand(side) {
            document.getElementById('btn-left').classList.remove('active');
            document.getElementById('btn-right').classList.remove('active');
            document.getElementById(`btn-${side}`).classList.add('active');
            if(side === 'left') { targetHand = 15; targetShoulder = 11; }
            else { targetHand = 16; targetShoulder = 12; }
        }

        // --- 変数 (Variables) ---
        let isRecording = false;
        let lastTime = 0;
        let lastWrist = null;
        
        // スタート位置の記憶用
        let startPositionDist = null; 

        // 計測データ
        let sessionData = { 
            totalEnergy: 0, 
            maxSpeed: 0, 
            maxReach: 0, 
            moveCount: 0, 
            totalDist: 0 
        };
        
        // カウント用ステートマシン
        let isReaching = false; 
        const REACH_THRESHOLD = 0.20; // スタート位置から+20cmでリーチ判定

        // UI要素
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        // グラフ初期化
        const ctxChart = document.getElementById('chart_canvas').getContext('2d');
        let chart = new Chart(ctxChart, {
            type: 'line',
            data: {
                labels: Array(50).fill(''),
                datasets: [{ 
                    data: Array(50).fill(0), 
                    borderColor: '#00ffcc', 
                    backgroundColor: 'rgba(0,255,204,0.2)', 
                    fill: true, tension: 0.1, pointRadius: 0 
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: { y: { display: true, min: 0 }, x: { display: false } },
                plugins: { legend: { display: false } }
            }
        });

        // --- シーケンス制御 ---
        function startSequence() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('countdown-ui').style.display = 'block';
            let count = 3;
            document.getElementById('count-val').innerText = count;

            // カウントダウン処理
            const cTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('count-val').innerText = count;
                } else {
                    clearInterval(cTimer);
                    document.getElementById('countdown-ui').style.display = 'none';
                    
                    // ★ここでスタート位置をリセット・決定
                    startPositionDist = null; 
                    startMeasurement();
                }
            }, 1000);
        }

        function startMeasurement() {
            isRecording = true;
            document.getElementById('recording-ui').style.display = 'block';
            
            // データリセット
            sessionData = { totalEnergy: 0, maxSpeed: 0, maxReach: 0, moveCount: 0, totalDist: 0 };
            isReaching = false;

            let timeLeft = 10.0;
            const timer = setInterval(() => {
                timeLeft -= 0.1;
                if(timeLeft < 0) timeLeft = 0;
                document.getElementById('timer-val').innerText = timeLeft.toFixed(1);
                
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    finishMeasurement();
                }
            }, 100);
        }

        function finishMeasurement() {
            isRecording = false;
            document.getElementById('recording-ui').style.display = 'none';
            document.getElementById('result-ui').style.display = 'block';
            
            document.getElementById('res-energy').innerText = sessionData.totalEnergy.toFixed(1);
            document.getElementById('res-count').innerText = sessionData.moveCount;
            document.getElementById('res-speed').innerText = sessionData.maxSpeed.toFixed(2);
            document.getElementById('res-reach').innerText = sessionData.maxReach.toFixed(2);
            document.getElementById('res-dist').innerText = sessionData.totalDist.toFixed(2);
        }

        // --- MediaPipe Loop ---
        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseWorldLandmarks && results.poseWorldLandmarks[targetHand]) {
                const hand3D = results.poseWorldLandmarks[targetHand];
                const shoulder3D = results.poseWorldLandmarks[targetShoulder];
                const hand2D = results.poseLandmarks[targetHand];

                if (hand3D && shoulder3D) {
                    const currentTime = Date.now();
                    
                    // 1. 肩からの絶対距離 (メートル)
                    const distFromShoulder = Math.sqrt(
                        Math.pow(hand3D.x - shoulder3D.x, 2) +
                        Math.pow(hand3D.y - shoulder3D.y, 2) +
                        Math.pow(hand3D.z - shoulder3D.z, 2)
                    );

                    // 計測開始直後、最初の値を「基準(Start Position)」にする
                    if (isRecording && startPositionDist === null) {
                        startPositionDist = distFromShoulder;
                    }

                    // 2. 速さとエネルギーの計算 (前フレームとの差分)
                    let velocity = 0;
                    if (lastWrist && lastTime > 0) {
                        const deltaTime = (currentTime - lastTime) / 1000;
                        if (deltaTime > 0) {
                            const moveDist = Math.sqrt(
                                Math.pow(hand3D.x - lastWrist.x, 2) +
                                Math.pow(hand3D.y - lastWrist.y, 2) +
                                Math.pow(hand3D.z - lastWrist.z, 2)
                            );
                            velocity = moveDist / deltaTime;
                            
                            // ノイズ除去（速すぎる移動は無視）
                            if(velocity < 15 && isRecording) {
                                // エネルギー計算 (1/2 mv^2)
                                const energy = 0.5 * Math.pow(velocity, 2);
                                sessionData.totalEnergy += energy;
                                sessionData.totalDist += moveDist;
                                if(velocity > sessionData.maxSpeed) sessionData.maxSpeed = velocity;
                                
                                // 画面更新
                                document.getElementById('rt-speed').innerText = velocity.toFixed(2);
                            }
                        }
                    }

                    // 3. グラフとカウント処理
                    if (isRecording && startPositionDist !== null) {
                        // スタート位置からの変位（どれだけ伸びたか）
                        const relativeReach = distFromShoulder - startPositionDist; 
                        
                        // グラフ更新 (絶対距離を表示)
                        const data = chart.data.datasets[0].data;
                        data.shift(); 
                        data.push(distFromShoulder); 
                        chart.update();

                        // リアルタイム表示
                        document.getElementById('rt-reach').innerText = distFromShoulder.toFixed(2);
                        if(distFromShoulder > sessionData.maxReach) sessionData.maxReach = distFromShoulder;

                        // ★カウントロジック (相対距離を使用)
                        // スタート位置から +20cm 伸びたら「リーチ中」
                        if (!isReaching && relativeReach > REACH_THRESHOLD) {
                            isReaching = true;
                        }
                        // スタート位置近く (+5cm以内) に戻ったら「カウント」
                        else if (isReaching && relativeReach < 0.05) {
                            isReaching = false;
                            sessionData.moveCount++;
                            document.getElementById('rt-count').innerText = sessionData.moveCount;
                        }
                    }

                    // 4. 描画 (手首の点)
                    const x = hand2D.x * canvasElement.width;
                    const y = hand2D.y * canvasElement.height;
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, 15, 0, 2 * Math.PI);
                    // リーチ中は赤、戻ったら青
                    canvasCtx.fillStyle = isReaching ? "#ff3366" : "#00ffcc";
                    canvasCtx.fill();

                    lastWrist = hand3D;
                    lastTime = currentTime;
                }
            }
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true });
        pose.onResults(onResults);
        
        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>