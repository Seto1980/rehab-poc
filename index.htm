<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rehab-Vis v3 Visual</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š --- */
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
        
        canvas#output_canvas { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            object-fit: cover; transform: scaleX(-1); z-index: 1;
        }
        .graph-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0; height: 25vh;
            background: rgba(0, 0, 0, 0.85); border-top: 1px solid #444; z-index: 10;
        }
        #chart_canvas { width: 100%; height: 100%; }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .hand-switch-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 6000; pointer-events: auto;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 30px;
            display: flex; gap: 10px; border: 1px solid #666;
        }
        .hand-btn {
            background: transparent; border: none; color: #ccc;
            padding: 8px 16px; font-weight: bold; cursor: pointer; border-radius: 20px;
        }
        .hand-btn.active { background: #00ffcc; color: #000; box-shadow: 0 0 10px #00ffcc; }

        /* ãƒãƒ‹ãƒ¥ã‚¢ãƒ« */
        #help-btn {
            position: absolute; top: 10px; right: 10px;
            background: #444; color: #fff; border: 1px solid #777;
            padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 12px;
        }
        #manual-modal {
            display: none; pointer-events: auto; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; overflow-y: auto;
        }
        .manual-content {
            background: #1a1a1a; margin: 20px auto; padding: 25px; width: 90%; max-width: 500px;
            border-radius: 15px; border: 1px solid #444; color: #eee; text-align: left;
            padding-bottom: 50px;
        }
        .manual-h3 { color:#00ffcc; border-bottom:1px solid #444; padding-bottom:5px; margin-top:20px; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            pointer-events: auto; text-align: center;
            background: rgba(0,0,0,0.8); padding: 30px; border-radius: 20px; border: 1px solid #555;
            position: relative;
        }
        #start-btn {
            background: linear-gradient(135deg, #00ffcc, #0099aa);
            border: none; padding: 15px 40px; font-size: 20px; 
            font-weight: bold; border-radius: 50px; cursor: pointer; margin-top: 20px;
            color: #000; box-shadow: 0 0 15px rgba(0,255,204,0.3);
            transition: transform 0.1s;
        }
        #start-btn:active { transform: scale(0.95); }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
        #countdown-ui { display: none; }
        .countdown-num { font-size: 120px; color: #00ffcc; font-weight: bold; text-shadow: 0 0 20px #000; }
        .guide-msg { font-size: 18px; color: #fff; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px;}

        /* è¨ˆæ¸¬ä¸­ */
        #recording-ui { display: none; text-align: center; width: 100%; }
        .timer { font-size: 80px; color: #fff; font-weight: bold; line-height: 1; }
        .realtime-box { 
            display: flex; justify-content: center; gap: 20px; margin-top: 10px; 
            background: rgba(0,0,0,0.5); padding: 10px;
        }
        .rt-item { text-align: center; }
        .rt-label { font-size: 10px; color: #aaa; }
        .rt-val { font-size: 24px; font-weight: bold; color: #00ffcc; }

        /* çµæœç”»é¢ */
        #result-ui {
            display: none; pointer-events: auto; background: rgba(15,15,15,0.98);
            padding: 20px; border-radius: 15px; border: 2px solid #00ffcc;
            width: 320px; color: #fff; text-align: center;
        }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .res-box { background: #222; padding: 10px; border-radius: 8px; }
        .res-big { font-size: 28px; font-weight: bold; color: #fff; }
        .retry-btn { background: #444; color: #fff; padding: 12px 30px; border-radius: 30px; border: none; cursor: pointer; font-size: 16px; margin-top: 10px; }
    </style>
</head>
<body>
    <video id="input_video" style="display:none" autoplay playsinline></video>

    <div class="hand-switch-container">
        <button class="hand-btn" id="btn-left" onclick="setHand('left')">å·¦è…• (Left)</button>
        <button class="hand-btn active" id="btn-right" onclick="setHand('right')">å³è…• (Right)</button>
    </div>

    <div id="manual-modal">
        <div class="manual-content">
            <h3 style="color:#00ffcc; margin-top:0;">ğŸ“˜ ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹</h3>
            <p>1. <strong>è‚©ã®ãƒãƒ¼ã‚¯</strong>ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ãã“ãŒè¨ˆæ¸¬ã®åŸºæº–ç‚¹ã§ã™ã€‚</p>
            <p>2. æ‰‹ã‚’å‹•ã‹ã™ã¨ã€é€Ÿåº¦ã«å¿œã˜ã¦<strong>è‰²ã®ã¤ã„ãŸè»Œè·¡</strong>ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            <p>3. <strong>ã€Œè¨ˆæ¸¬é–‹å§‹ã€</strong>ã‚’æŠ¼ã™å‰ã‹ã‚‰ã‚°ãƒ©ãƒ•ã¯å‹•ãã¾ã™ã€‚ã‚«ãƒ¡ãƒ©ã®ä½ç½®èª¿æ•´ã«ä½¿ã£ã¦ãã ã•ã„ã€‚</p>
            <button class="retry-btn" onclick="document.getElementById('manual-modal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div class="ui-layer">
        <div id="start-screen">
            <button id="help-btn" onclick="document.getElementById('manual-modal').style.display='block'">ä½¿ã„æ–¹</button>
            <h2 style="color:#fff; margin-bottom: 5px;">Rehab Analytics</h2>
            <div style="color:#888; font-size:12px;">Visual Feedback: V3</div>
            <button id="start-btn" onclick="startSequence()">è¨ˆæ¸¬é–‹å§‹</button>
        </div>

        <div id="countdown-ui">
            <div class="guide-msg">ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ã§é™æ­¢...</div>
            <div class="countdown-num" id="count-val">3</div>
        </div>

        <div id="recording-ui">
            <div style="color:#ff3366; font-weight:bold; animation: blink 1s infinite;">â— RECORDING</div>
            <div class="timer" id="timer-val">10.0</div>
            <div class="realtime-box">
                <div class="rt-item"><div class="rt-label">COUNT</div><div class="rt-val" id="rt-count">0</div></div>
                <div class="rt-item"><div class="rt-label">REACH</div><div class="rt-val"><span id="rt-reach">0.0</span> m</div></div>
            </div>
            <div id="debug-msg" style="font-size:10px; color:#555; margin-top:5px;"></div>
        </div>

        <div id="result-ui">
            <h3 style="margin:0 0 15px 0; color:#00ffcc;">RESULT</h3>
            <div style="margin-bottom: 20px;">
                <div style="font-size:12px; color:#aaa;">TOTAL ENERGY</div>
                <div style="font-size:40px; font-weight:bold; color:#00ffcc;" id="res-energy">0.0</div>
            </div>
            <div class="res-grid">
                <div class="res-box"><div style="font-size:10px; color:#aaa;">COUNT</div><div class="res-big" id="res-count">0</div></div>
                <div class="res-box"><div style="font-size:10px; color:#aaa;">MAX REACH</div><div class="res-big" id="res-reach">0.0</div></div>
            </div>
            <button class="retry-btn" onclick="location.reload()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <canvas id="output_canvas"></canvas>
    <div class="graph-wrapper"><canvas id="chart_canvas"></canvas></div>

    <script>
        // --- è¨­å®š (Setting) ---
        let targetHand = 16; 
        let targetShoulder = 12;

        function setHand(side) {
            document.getElementById('btn-left').classList.remove('active');
            document.getElementById('btn-right').classList.remove('active');
            document.getElementById(`btn-${side}`).classList.add('active');
            if(side === 'left') { targetHand = 15; targetShoulder = 11; }
            else { targetHand = 16; targetShoulder = 12; }
            pathHistory = []; // æ‰‹ã‚’å¤‰ãˆãŸã‚‰è»Œè·¡ã‚‚ãƒªã‚»ãƒƒãƒˆ
        }

        // --- å¤‰æ•° (Variables) ---
        let isRecording = false;
        let lastTime = 0;
        let lastWrist = null;
        let startPositionDist = null; 
        
        // è»Œè·¡æç”»ç”¨é…åˆ—
        let pathHistory = [];

        // ãƒ‡ãƒ¼ã‚¿
        let sessionData = { totalEnergy: 0, maxSpeed: 0, maxReach: 0, moveCount: 0, totalDist: 0 };
        let isReaching = false; 
        const REACH_LIMIT = 0.15; 
        const RETURN_LIMIT = 0.10; 

        // UI
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const debugMsg = document.getElementById('debug-msg');
        
        // ã‚°ãƒ©ãƒ•
        const ctxChart = document.getElementById('chart_canvas').getContext('2d');
        let chart = new Chart(ctxChart, {
            type: 'line',
            data: {
                labels: Array(50).fill(''),
                datasets: [{ 
                    data: Array(50).fill(0), 
                    borderColor: '#00ffcc', 
                    backgroundColor: 'rgba(0,255,204,0.1)', // è–„ãå¡—ã‚Šã¤ã¶ã—
                    borderWidth: 2,
                    fill: true, tension: 0.4, pointRadius: 0 
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: { 
                    y: { display: true, min: 0, grid: { color: '#333'} }, 
                    x: { display: false } 
                },
                plugins: { legend: { display: false } }
            }
        });

        // --- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹åˆ¶å¾¡ ---
        function startSequence() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('countdown-ui').style.display = 'block';
            let count = 3;
            document.getElementById('count-val').innerText = count;

            const cTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('count-val').innerText = count;
                } else {
                    clearInterval(cTimer);
                    document.getElementById('countdown-ui').style.display = 'none';
                    startPositionDist = null; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³çµ‚äº†æ™‚ã«ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
                    startMeasurement();
                }
            }, 1000);
        }

        function startMeasurement() {
            isRecording = true;
            document.getElementById('recording-ui').style.display = 'block';
            sessionData = { totalEnergy: 0, maxSpeed: 0, maxReach: 0, moveCount: 0, totalDist: 0 };
            isReaching = false;

            let timeLeft = 10.0;
            const timer = setInterval(() => {
                timeLeft -= 0.1;
                if(timeLeft < 0) timeLeft = 0;
                document.getElementById('timer-val').innerText = timeLeft.toFixed(1);
                
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    finishMeasurement();
                }
            }, 100);
        }

        function finishMeasurement() {
            isRecording = false;
            document.getElementById('recording-ui').style.display = 'none';
            document.getElementById('result-ui').style.display = 'block';
            document.getElementById('res-energy').innerText = sessionData.totalEnergy.toFixed(1);
            document.getElementById('res-count').innerText = sessionData.moveCount;
            document.getElementById('res-reach').innerText = sessionData.maxReach.toFixed(2);
        }

        // --- MediaPipe Loop ---
        function onResults(results) {
            // 1. ã‚­ãƒ£ãƒ³ãƒã‚¹ãƒªã‚»ãƒƒãƒˆ
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseWorldLandmarks && results.poseWorldLandmarks[targetHand]) {
                const hand3D = results.poseWorldLandmarks[targetHand];
                const shoulder3D = results.poseWorldLandmarks[targetShoulder];
                const hand2D = results.poseLandmarks[targetHand];
                const shoulder2D = results.poseLandmarks[targetShoulder];

                if (hand3D && shoulder3D) {
                    const currentTime = Date.now();
                    const currentDist = Math.sqrt(
                        Math.pow(hand3D.x - shoulder3D.x, 2) +
                        Math.pow(hand3D.y - shoulder3D.y, 2) +
                        Math.pow(hand3D.z - shoulder3D.z, 2)
                    );

                    // ã‚¹ã‚¿ãƒ¼ãƒˆä½ç½®è‡ªå‹•ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (è¨ˆæ¸¬é–‹å§‹ç›´å¾Œã«å›ºå®š)
                    if (isRecording && startPositionDist === null) {
                        startPositionDist = currentDist;
                    }
                    
                    // --- é€Ÿåº¦è¨ˆç®— (ã‚¨ãƒãƒ«ã‚®ãƒ¼ & ãƒˆãƒ¬ã‚¤ãƒ«ã®è‰²ç”¨) ---
                    let velocity = 0;
                    if (lastWrist && lastTime > 0) {
                        const deltaTime = (currentTime - lastTime) / 1000;
                        if (deltaTime > 0) {
                            const distDelta = Math.sqrt(
                                Math.pow(hand3D.x - lastWrist.x, 2) +
                                Math.pow(hand3D.y - lastWrist.y, 2) +
                                Math.pow(hand3D.z - lastWrist.z, 2)
                            );
                            velocity = distDelta / deltaTime;
                            if(velocity > 20) velocity = 0; // ãƒã‚¤ã‚ºã‚«ãƒƒãƒˆ
                        }
                    }

                    // --- è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–° (Recordingä¸­ã®ã¿) ---
                    if (isRecording && startPositionDist !== null) {
                        const moveVal = currentDist - startPositionDist;
                        const energy = 0.5 * Math.pow(velocity, 2);
                        
                        // ç©ç®—
                        sessionData.totalEnergy += energy;
                        if(currentDist > sessionData.maxReach) sessionData.maxReach = currentDist;

                        // ã‚«ã‚¦ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯
                        if (!isReaching && moveVal > REACH_LIMIT) {
                            isReaching = true;
                            debugMsg.innerText = "Reaching...";
                        } else if (isReaching && moveVal < RETURN_LIMIT) {
                            isReaching = false;
                            sessionData.moveCount++;
                            document.getElementById('rt-count').innerText = sessionData.moveCount;
                            debugMsg.innerText = "Count!";
                        }
                        
                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
                        document.getElementById('rt-reach').innerText = currentDist.toFixed(2);
                    }

                    // --- ã‚°ãƒ©ãƒ•æ›´æ–° (å¸¸æ™‚: Always On) ---
                    // è¨ˆæ¸¬å‰ã§ã‚‚æ³¢å½¢ãŒå‡ºã‚‹ã®ã§ã€èªè­˜ãƒã‚§ãƒƒã‚¯ãŒã§ãã‚‹
                    const data = chart.data.datasets[0].data;
                    data.shift(); 
                    data.push(currentDist); 
                    chart.update();

                    // --- æç”»1: è»Œè·¡ (Motion Trail) ---
                    // å±¥æ­´ã«è¿½åŠ 
                    const px = hand2D.x * canvasElement.width;
                    const py = hand2D.y * canvasElement.height;
                    pathHistory.push({ x: px, y: py, speed: velocity });
                    if(pathHistory.length > 15) pathHistory.shift(); // è»Œè·¡ã®é•·ã•

                    // è»Œè·¡ã‚’æç”»
                    if(pathHistory.length > 1) {
                        canvasCtx.lineCap = 'round';
                        canvasCtx.lineWidth = 6;
                        
                        for (let i = 0; i < pathHistory.length - 1; i++) {
                            const pt1 = pathHistory[i];
                            const pt2 = pathHistory[i+1];
                            const speed = pt2.speed;
                            
                            // è‰²ã®è¨ˆç®—: é…ã„=é’(240), é€Ÿã„=èµ¤(0)
                            // speed 0~3m/s ã‚’ Hue 240~0 ã«ãƒãƒƒãƒ”ãƒ³ã‚°
                            let hue = 240 - (speed * 80);
                            if (hue < 0) hue = 0; // èµ¤ã§æ­¢ã‚ã‚‹
                            if (hue > 240) hue = 240; // é’ã§æ­¢ã‚ã‚‹

                            // é€æ˜åº¦: å¤ã„ã»ã©è–„ã
                            const alpha = (i / pathHistory.length);

                            canvasCtx.beginPath();
                            canvasCtx.moveTo(pt1.x, pt1.y);
                            canvasCtx.lineTo(pt2.x, pt2.y);
                            canvasCtx.strokeStyle = `hsla(${hue}, 100%, 60%, ${alpha})`;
                            canvasCtx.stroke();
                        }
                    }

                    // --- æç”»2: è‚©ã®ãƒãƒ¼ã‚«ãƒ¼ (Anchor) ---
                    const sx = shoulder2D.x * canvasElement.width;
                    const sy = shoulder2D.y * canvasElement.height;
                    
                    // å¤–å´ã®ãƒªãƒ³ã‚°
                    canvasCtx.beginPath();
                    canvasCtx.arc(sx, sy, 15, 0, 2 * Math.PI);
                    canvasCtx.lineWidth = 3;
                    canvasCtx.strokeStyle = "#FF9900"; // ã‚ªãƒ¬ãƒ³ã‚¸
                    canvasCtx.stroke();
                    // ä¸­å¿ƒã®ç‚¹
                    canvasCtx.beginPath();
                    canvasCtx.arc(sx, sy, 5, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = "#FF9900";
                    canvasCtx.fill();
                    // ãƒ©ãƒ™ãƒ«
                    canvasCtx.fillStyle = "#FF9900";
                    canvasCtx.font = "12px Arial";
                    canvasCtx.fillText("Shoulder", sx + 20, sy);

                    // --- æç”»3: æ‰‹ã®ãƒãƒ¼ã‚«ãƒ¼ (Mover) ---
                    canvasCtx.beginPath();
                    canvasCtx.arc(px, py, 10, 0, 2 * Math.PI);
                    canvasCtx.fillStyle = isReaching ? "#FF0055" : "#00FFFF"; // ãƒªãƒ¼ãƒä¸­ã¯ãƒ”ãƒ³ã‚¯ã€é€šå¸¸ã¯ã‚·ã‚¢ãƒ³
                    canvasCtx.fill();
                    // ç™½ã„æ ç·šã§ç›®ç«‹ãŸã›ã‚‹
                    canvasCtx.strokeStyle = "#fff";
                    canvasCtx.lineWidth = 2;
                    canvasCtx.stroke();

                    // æ›´æ–°ç”¨å¤‰æ•°
                    lastWrist = hand3D;
                    lastTime = currentTime;
                }
            }
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true });
        pose.onResults(onResults);
        
        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>