<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rehab-Vis Pro v4 (Full Metrics)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- å…¨ä½“è¨­å®š --- */
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: "Helvetica Neue", Arial, sans-serif; }
        
        /* æ˜ åƒã¨ã‚°ãƒ©ãƒ• */
        canvas#output_canvas { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            object-fit: cover; transform: scaleX(-1); z-index: 1;
        }
        .graph-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0; height: 25vh;
            background: rgba(0, 0, 0, 0.85); border-top: 1px solid #444; z-index: 10;
        }
        #chart_canvas { width: 100%; height: 100%; }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* å·¦å³åˆ‡æ›¿ */
        .hand-switch-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 6000; pointer-events: auto;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 30px;
            display: flex; gap: 10px; border: 1px solid #666;
        }
        .hand-btn {
            background: transparent; border: none; color: #ccc;
            padding: 8px 16px; font-weight: bold; cursor: pointer; border-radius: 20px;
        }
        .hand-btn.active { background: #00ffcc; color: #000; box-shadow: 0 0 10px #00ffcc; }

        /* ãƒãƒ‹ãƒ¥ã‚¢ãƒ« (èª¬æ˜æ›¸) */
        #manual-modal {
            display: none; pointer-events: auto; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; overflow-y: auto;
        }
        .manual-content {
            background: #1a1a1a; margin: 40px auto; padding: 30px; width: 90%; max-width: 600px;
            border-radius: 15px; border: 1px solid #444; color: #eee; text-align: left;
            padding-bottom: 60px;
        }
        .manual-badge {
            background: #00ffcc; color: #000; padding: 5px 10px; border-radius: 4px;
            font-weight: bold; font-size: 12px; display: inline-block; margin-bottom: 10px;
        }
        .manual-h3 { color:#00ffcc; border-bottom:1px solid #444; padding-bottom:5px; margin-top:25px; font-size: 18px; }
        .manual-p { font-size: 14px; line-height: 1.6; color: #ccc; margin: 10px 0; }
        .manual-li { font-size: 14px; line-height: 1.6; color: #ccc; margin-left: 20px; margin-bottom: 5px; }
        .manual-warn { 
            border: 1px solid #ff5555; background: rgba(255,85,85,0.1); 
            padding: 10px; border-radius: 8px; font-size: 13px; color: #ffcccc; margin-top: 10px;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            pointer-events: auto; text-align: center;
            background: rgba(0,0,0,0.85); padding: 40px; border-radius: 20px; border: 1px solid #555;
        }
        #start-btn {
            background: linear-gradient(135deg, #00ffcc, #0099aa);
            border: none; padding: 15px 50px; font-size: 20px; 
            font-weight: bold; border-radius: 50px; cursor: pointer; margin-top: 25px;
            color: #000; box-shadow: 0 0 15px rgba(0,255,204,0.3);
        }
        #help-btn {
            margin-top: 15px; background: transparent; border: 1px solid #666; color: #aaa;
            padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 14px;
        }

        /* ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”»é¢ */
        #calibration-ui { display: none; text-align: center; background: rgba(0,0,0,0.8); padding: 30px; border-radius: 20px; border: 2px solid #ffcc00; }
        .calib-title { font-size: 24px; color: #ffcc00; font-weight: bold; margin-bottom: 10px; }
        .calib-desc { font-size: 16px; color: #fff; line-height: 1.5; }
        .calib-timer { font-size: 60px; color: #fff; font-weight: bold; margin-top: 15px; }

        /* è¨ˆæ¸¬ä¸­ */
        #recording-ui { display: none; text-align: center; width: 100%; }
        .timer { font-size: 80px; color: #fff; font-weight: bold; line-height: 1; }
        .realtime-box { 
            display: flex; justify-content: center; gap: 20px; margin-top: 10px; 
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px;
        }
        .rt-item { text-align: center; }
        .rt-label { font-size: 11px; color: #aaa; margin-bottom: 3px; }
        .rt-val { font-size: 32px; font-weight: bold; color: #00ffcc; }
        .rt-sub-val { font-size: 18px; color: #00ffcc; font-weight: bold; }
        .rt-unit { font-size: 14px; color: #888; margin-left: 2px;}

        /* çµæœç”»é¢ */
        #result-ui {
            display: none; pointer-events: auto; background: rgba(20,20,20,0.98);
            padding: 30px; border-radius: 20px; border: 2px solid #00ffcc;
            width: 340px; color: #fff; text-align: center;
        }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .res-box { background: #333; padding: 10px; border-radius: 8px; }
        .res-label { font-size: 10px; color: #aaa; margin-bottom: 5px; }
        .res-big { font-size: 24px; font-weight: bold; color: #fff; }
        .retry-btn { background: #444; color: #fff; padding: 12px 30px; border-radius: 30px; border: none; cursor: pointer; font-size: 16px; margin-top: 10px; }
        
        .debug-state { font-size: 12px; color: #555; margin-top: 5px; }
    </style>
</head>
<body>
    <video id="input_video" style="display:none" autoplay playsinline></video>

    <div class="hand-switch-container">
        <button class="hand-btn" id="btn-left" onclick="setHand('left')">å·¦è…• (Left)</button>
        <button class="hand-btn active" id="btn-right" onclick="setHand('right')">å³è…• (Right)</button>
    </div>

    <div id="manual-modal">
        <div class="manual-content">
            <span class="manual-badge">èªå®šä½œæ¥­ç™‚æ³•å£«ç›£ä¿®</span>
            <h2 style="color:#fff; margin-top:5px; border-bottom:1px solid #555; padding-bottom:15px;">å–æ‰±èª¬æ˜æ›¸</h2>
            
            <div class="manual-h3">1. ç›®çš„ (Purpose)</div>
            <p class="manual-p">
                æœ¬ã‚¢ãƒ—ãƒªã¯ã€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ä¸Šè‚¢æ©Ÿèƒ½ï¼ˆãƒªãƒ¼ãƒå‹•ä½œï¼‰ã‚’å¯è¦–åŒ–ã—ã€æ‚£è€…æ§˜è‡ªèº«ã®ã€Œæ°—ã¥ãã€ã¨ã€Œãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å‘ä¸Šã€ã‚’æ”¯æ´ã—ã¾ã™ã€‚<br>
                ã€Œä¼¸ã³ãŸè·é›¢ï¼ˆï¼…ï¼‰ã€ã ã‘ã§ãªãã€ã€Œå‹•ã„ãŸé€Ÿã•ï¼ˆSpeedï¼‰ã€ã‚„ã€Œé‹å‹•é‡ï¼ˆEnergyï¼‰ã€ã‚‚åŒæ™‚ã«è¨ˆæ¸¬ã—ã€ç·åˆçš„ãªé‹å‹•ã®è³ªã‚’è©•ä¾¡ã—ã¾ã™ã€‚
            </p>

            <div class="manual-h3">2. ä½¿ã„æ–¹ (Usage)</div>
            <p class="manual-p"><strong>STEP 1: æº–å‚™</strong><br>
            ã‚«ãƒ¡ãƒ©ã«å¯¾ã—ã¦æ¨ªå‘ãã€ã¾ãŸã¯æ­£é¢ã«åº§ã‚Šã¾ã™ã€‚</p>
            
            <p class="manual-p"><strong>STEP 2: ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæœ€å¤§æ¸¬å®šï¼‰</strong><br>
            æœ€åˆã®5ç§’é–“ã§<span style="color:#ffcc00;">è…•ã‚’é™ç•Œã¾ã§å¤§ããä¼¸ã°ã—ã¦ãã ã•ã„ã€‚</span>ãã®è·é›¢ãŒã€Œ100%ã€ã¨ã—ã¦è¨˜æ†¶ã•ã‚Œã¾ã™ã€‚</p>

            <p class="manual-p"><strong>STEP 3: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</strong><br>
            10ç§’é–“ã®è¨ˆæ¸¬ã§ã€å¤§ããç´ æ—©ãå‹•ã‹ã—ã¾ã—ã‚‡ã†ã€‚<br>
            ãƒ»æœ€å¤§ï¼ˆ100%ï¼‰ã®<strong>70%</strong>ãƒ©ã‚¤ãƒ³ã‚’è¶…ãˆã‚‹ã¨ã€Œãƒªãƒ¼ãƒã€<br>
            ãƒ»æ‰‹å…ƒï¼ˆ30%ï¼‰ã¾ã§æˆ»ã™ã¨ã€Œ1å›ã€ã¨ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚</p>

            <div class="manual-h3">3. çµæœã®è§£é‡ˆ (Interpretation)</div>
            <ul>
                <li class="manual-li"><strong>COUNT (å›æ•°):</strong><br>æ­£ç¢ºã«å¾€å¾©é‹å‹•ãŒã§ããŸå›æ•°ã§ã™ã€‚</li>
                <li class="manual-li"><strong>MAX % (æœ€å¤§åˆ°é”ç‡):</strong><br>å€‹äººã®æœ€å¤§å¯å‹•åŸŸã«å¯¾ã™ã‚‹é”æˆåº¦ã§ã™ã€‚</li>
                <li class="manual-li"><strong>MAX SPEED (ç¬ç™ºåŠ›):</strong><br>å‹•ãã®æœ€å¤§é€Ÿåº¦ (m/s) ã§ã™ã€‚éº»ç—ºå´ã®åˆå‹•ã®é€Ÿã•ãªã©ã®è©•ä¾¡ã«å½¹ç«‹ã¡ã¾ã™ã€‚</li>
                <li class="manual-li"><strong>ENERGY (ç·é‹å‹•é‡):</strong><br>ã€Œé€Ÿã•Ã—å›æ•°ã€ã®ç·å’Œã§ã™ã€‚æ•°å€¤ãŒé«˜ã„ã»ã©ã€åŠ›å¼·ããŸãã•ã‚“å‹•ã„ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚</li>
            </ul>

            <button class="retry-btn" onclick="document.getElementById('manual-modal').style.display='none'">é–‰ã˜ã¦è¨ˆæ¸¬ã¸</button>
        </div>
    </div>

    <div class="ui-layer">
        <div id="start-screen">
            <h2 style="color:#fff; margin-bottom: 5px;">Rehab Analytics Pro</h2>
            <div style="color:#aaa; font-size:14px;">Full Metrics: Reach, Speed & Energy</div>
            
            <button id="start-btn" onclick="startCalibration()">æ¸¬å®šé–‹å§‹</button>
            <br>
            <button id="help-btn" onclick="document.getElementById('manual-modal').style.display='block'">èª¬æ˜æ›¸ã‚’è¦‹ã‚‹</button>
        </div>

        <div id="calibration-ui">
            <div class="calib-title">ğŸ“ æœ€å¤§ãƒªãƒ¼ãƒæ¸¬å®šä¸­</div>
            <div class="calib-desc">
                è…•ã‚’<strong>ä¸€ç•ªé ãã¾ã§</strong>ä¼¸ã°ã—ã¦ãã ã•ã„ï¼<br>
                ãã®è·é›¢ã‚’ã€Œ100%ã€ã®åŸºæº–ã«ã—ã¾ã™ã€‚
            </div>
            <div class="calib-timer" id="calib-timer">5</div>
        </div>

        <div id="recording-ui">
            <div style="color:#ff3366; font-weight:bold; animation: blink 1s infinite;">â— RECORDING</div>
            <div class="timer" id="timer-val">10.0</div>
            
            <div class="realtime-box">
                <div class="rt-item">
                    <div class="rt-label">COUNT</div>
                    <div class="rt-val" id="rt-count">0</div>
                </div>
                <div class="rt-item">
                    <div class="rt-label">REACH RATE</div>
                    <div class="rt-val"><span id="rt-percent">0</span><span class="rt-unit">%</span></div>
                </div>
                <div class="rt-item">
                    <div class="rt-label">SPEED</div>
                    <div class="rt-sub-val"><span id="rt-speed">0.0</span> <span style="font-size:10px">m/s</span></div>
                </div>
            </div>
            <div class="debug-state" id="debug-msg">State: Wait</div>
        </div>

        <div id="result-ui">
            <h3 style="margin:0 0 15px 0; color:#00ffcc;">RESULT</h3>
            
            <div class="res-grid">
                <div class="res-box">
                    <div class="res-label">COUNT</div>
                    <div class="res-big" id="res-count">0</div>
                </div>
                <div class="res-box">
                    <div class="res-label">MAX REACH</div>
                    <div class="res-big"><span id="res-max-pct">0</span><span style="font-size:14px">%</span></div>
                </div>
                <div class="res-box">
                    <div class="res-label">MAX SPEED</div>
                    <div class="res-big"><span id="res-max-speed">0.0</span><span style="font-size:14px">m/s</span></div>
                </div>
                <div class="res-box">
                    <div class="res-label">TOTAL ENERGY</div>
                    <div class="res-big" id="res-energy">0.0</div>
                </div>
            </div>
            
            <button class="retry-btn" onclick="location.reload()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <canvas id="output_canvas"></canvas>
    <div class="graph-wrapper"><canvas id="chart_canvas"></canvas></div>

    <script>
        // --- è¨­å®š (Setting) ---
        let targetHand = 16; 
        let targetShoulder = 12;

        function setHand(side) {
            document.getElementById('btn-left').classList.remove('active');
            document.getElementById('btn-right').classList.remove('active');
            document.getElementById(`btn-${side}`).classList.add('active');
            if(side === 'left') { targetHand = 15; targetShoulder = 11; }
            else { targetHand = 16; targetShoulder = 12; }
            pathHistory = [];
        }

        // --- å¤‰æ•° (Variables) ---
        let appState = 'idle'; 
        let lastTime = 0;
        let lastWrist = null;
        
        // åŸºæº–å€¤ (æœ€å¤§ãƒªãƒ¼ãƒ)
        let calibratedMaxReach = 0.001; 

        // è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿
        let sessionData = { 
            totalEnergy: 0, 
            maxPercent: 0, 
            maxSpeed: 0, 
            moveCount: 0 
        };
        
        // ã‚«ã‚¦ãƒ³ãƒˆé–¾å€¤
        let isReaching = false; 
        const THRESHOLD_HIGH = 0.70; 
        const THRESHOLD_LOW = 0.30; 

        // UI
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const debugMsg = document.getElementById('debug-msg');
        let pathHistory = [];

        // ã‚°ãƒ©ãƒ•è¨­å®š (0-120%)
        const ctxChart = document.getElementById('chart_canvas').getContext('2d');
        let chart = new Chart(ctxChart, {
            type: 'line',
            data: {
                labels: Array(60).fill(''),
                datasets: [{ 
                    data: Array(60).fill(0), 
                    borderColor: '#00ffcc', 
                    backgroundColor: 'rgba(0,255,204,0.1)', 
                    fill: true, tension: 0.3, pointRadius: 0 
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: { 
                    y: { display: true, min: 0, max: 120, grid: { color: '#333'} }, 
                    x: { display: false } 
                },
                plugins: { legend: { display: false } }
            }
        });

        // --- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ ---
        
        // 1. ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ (5ç§’)
        function startCalibration() {
            appState = 'calibration';
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('calibration-ui').style.display = 'block';
            
            calibratedMaxReach = 0; 
            let count = 5;
            document.getElementById('calib-timer').innerText = count;

            const cTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('calib-timer').innerText = count;
                } else {
                    clearInterval(cTimer);
                    document.getElementById('calibration-ui').style.display = 'none';
                    if(calibratedMaxReach < 0.1) calibratedMaxReach = 0.3; // å®‰å…¨ç­–
                    startMeasurement();
                }
            }, 1000);
        }

        // 2. è¨ˆæ¸¬ (10ç§’)
        function startMeasurement() {
            appState = 'recording';
            document.getElementById('recording-ui').style.display = 'block';
            sessionData = { totalEnergy: 0, maxPercent: 0, maxSpeed: 0, moveCount: 0 };
            isReaching = false;

            let timeLeft = 10.0;
            const timer = setInterval(() => {
                timeLeft -= 0.1;
                if(timeLeft < 0) timeLeft = 0;
                document.getElementById('timer-val').innerText = timeLeft.toFixed(1);
                
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    finishMeasurement();
                }
            }, 100);
        }

        // 3. çµæœ
        function finishMeasurement() {
            appState = 'result';
            document.getElementById('recording-ui').style.display = 'none';
            document.getElementById('result-ui').style.display = 'block';
            
            document.getElementById('res-count').innerText = sessionData.moveCount;
            document.getElementById('res-max-pct').innerText = sessionData.maxPercent.toFixed(0);
            document.getElementById('res-max-speed').innerText = sessionData.maxSpeed.toFixed(2);
            document.getElementById('res-energy').innerText = sessionData.totalEnergy.toFixed(1);
        }

        // --- MediaPipe å‡¦ç† ---
        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseWorldLandmarks && results.poseWorldLandmarks[targetHand]) {
                const hand3D = results.poseWorldLandmarks[targetHand];
                const shoulder3D = results.poseWorldLandmarks[targetShoulder];
                const hand2D = results.poseLandmarks[targetHand];
                const shoulder2D = results.poseLandmarks[targetShoulder];

                if (hand3D && shoulder3D) {
                    // è·é›¢è¨ˆç®— (ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢)
                    const dist = Math.sqrt(
                        Math.pow(hand3D.x - shoulder3D.x, 2) +
                        Math.pow(hand3D.y - shoulder3D.y, 2) +
                        Math.pow(hand3D.z - shoulder3D.z, 2)
                    );

                    // A. ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­: æœ€å¤§å€¤æ›´æ–°
                    if (appState === 'calibration') {
                        if (dist > calibratedMaxReach) calibratedMaxReach = dist;
                    }
                    
                    // B. è¨ˆæ¸¬ä¸­: ï¼…åˆ¤å®š + Speed/Energy
                    else if (appState === 'recording') {
                        let ratio = dist / calibratedMaxReach;
                        if(ratio > 1.2) ratio = 1.2; 
                        const percent = ratio * 100;

                        // UIæ›´æ–°
                        document.getElementById('rt-percent').innerText = percent.toFixed(0);
                        
                        // ã‚°ãƒ©ãƒ•
                        const data = chart.data.datasets[0].data;
                        data.shift(); data.push(percent); chart.update();

                        if(percent > sessionData.maxPercent) sessionData.maxPercent = percent;

                        // ã‚«ã‚¦ãƒ³ãƒˆåˆ¤å®š
                        if (!isReaching && ratio > THRESHOLD_HIGH) {
                            isReaching = true;
                            debugMsg.innerText = "Reaching (>70%)";
                        } else if (isReaching && ratio < THRESHOLD_LOW) {
                            isReaching = false;
                            sessionData.moveCount++;
                            document.getElementById('rt-count').innerText = sessionData.moveCount;
                            debugMsg.innerText = "Return (<30%) Count!";
                        }

                        // â˜…Speed & Energy è¨ˆç®— (å¾©æ´»)
                        const currentTime = Date.now();
                        if (lastWrist && lastTime > 0) {
                            const dt = (currentTime - lastTime) / 1000; // ç§’
                            if (dt > 0) {
                                // 3æ¬¡å…ƒè·é›¢ã®ç§»å‹•é‡
                                const moveDist = Math.sqrt(
                                    Math.pow(hand3D.x - lastWrist.x, 2) +
                                    Math.pow(hand3D.y - lastWrist.y, 2) +
                                    Math.pow(hand3D.z - lastWrist.z, 2)
                                );
                                let speed = moveDist / dt; // m/s
                                
                                // ãƒã‚¤ã‚ºå‡¦ç† (20m/sä»¥ä¸Šã¯ç„¡è¦–)
                                if (speed < 20) {
                                    // é‹å‹•é‡ (ç°¡æ˜“: 0.5 * v^2)
                                    sessionData.totalEnergy += (0.5 * speed * speed);
                                    
                                    // æœ€å¤§é€Ÿåº¦
                                    if(speed > sessionData.maxSpeed) sessionData.maxSpeed = speed;
                                    
                                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€Ÿåº¦è¡¨ç¤º
                                    document.getElementById('rt-speed').innerText = speed.toFixed(1);
                                }
                            }
                        }
                    }

                    // C. æç”» (Visuals)
                    const px = hand2D.x * canvasElement.width;
                    const py = hand2D.y * canvasElement.height;
                    const sx = shoulder2D.x * canvasElement.width;
                    const sy = shoulder2D.y * canvasElement.height;

                    // å…±é€šãƒãƒ¼ã‚«ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³
                    drawMarker(sx, sy, "#00FFFF", "Shoulder"); // è‚©
                    drawMarker(px, py, isReaching ? "#FF3366" : "#00FFFF", "Hand"); // æ‰‹

                    lastWrist = hand3D;
                    lastTime = Date.now();
                }
            }
        }

        function drawMarker(x, y, color, label) {
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 12, 0, 2 * Math.PI);
            canvasCtx.fillStyle = color;
            canvasCtx.fill();
            canvasCtx.strokeStyle = "#fff";
            canvasCtx.lineWidth = 3;
            canvasCtx.stroke();
            
            // ãƒ©ãƒ™ãƒ«
            if(label) {
                canvasCtx.fillStyle = "#fff";
                canvasCtx.font = "bold 12px Arial";
                canvasCtx.fillText(label, x + 18, y + 4);
            }
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true });
        pose.onResults(onResults);
        
        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>