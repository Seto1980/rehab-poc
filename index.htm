<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rehab-Vis Pro v7 (Training Mode)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- å…¨ä½“è¨­å®š --- */
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: "Helvetica Neue", Arial, sans-serif; }
        
        canvas#output_canvas { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            object-fit: cover; transform: scaleX(-1); z-index: 1;
        }
        .graph-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0; height: 25vh;
            background: rgba(0, 0, 0, 0.85); border-top: 1px solid #444; z-index: 10;
        }
        #chart_canvas { width: 100%; height: 100%; }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5000; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* å·¦å³åˆ‡æ›¿ */
        .hand-switch-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 6000; pointer-events: auto;
            background: rgba(0,0,0,0.6); padding: 5px; border-radius: 30px;
            display: flex; gap: 10px; border: 1px solid #666;
        }
        .hand-btn {
            background: transparent; border: none; color: #ccc;
            padding: 8px 16px; font-weight: bold; cursor: pointer; border-radius: 20px;
        }
        .hand-btn.active { background: #00ffcc; color: #000; box-shadow: 0 0 10px #00ffcc; }

        /* ãƒãƒ‹ãƒ¥ã‚¢ãƒ« (èª¬æ˜æ›¸) */
        #manual-modal {
            display: none; pointer-events: auto; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999; overflow-y: auto;
        }
        .manual-content {
            background: #1a1a1a; margin: 40px auto; padding: 30px; width: 90%; max-width: 600px;
            border-radius: 15px; border: 1px solid #444; color: #eee; text-align: left;
            padding-bottom: 40px;
        }
        .manual-badge {
            background: #00ffcc; color: #000; padding: 5px 10px; border-radius: 4px;
            font-weight: bold; font-size: 12px; display: inline-block; margin-bottom: 10px;
        }
        .manual-h3 { color:#00ffcc; border-bottom:1px solid #444; padding-bottom:5px; margin-top:25px; font-size: 18px; font-weight: bold; }
        .manual-p { font-size: 14px; line-height: 1.6; color: #ccc; margin: 10px 0; }
        .manual-li { font-size: 14px; line-height: 1.6; color: #ccc; margin-left: 20px; margin-bottom: 5px; }
        .manual-warn { 
            border: 1px solid #ff5555; background: rgba(255,85,85,0.15); 
            padding: 15px; border-radius: 8px; font-size: 13px; color: #ffcccc; margin-top: 15px;
        }
        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’ä¸­å¤®å¯„ã› */
        .manual-close-wrapper { text-align: center; margin-top: 30px; }
        .retry-btn { background: #444; color: #fff; padding: 12px 30px; border-radius: 30px; border: none; cursor: pointer; font-size: 16px; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            pointer-events: auto; text-align: center;
            background: rgba(0,0,0,0.85); padding: 40px; border-radius: 20px; border: 1px solid #555;
            width: 80%; max-width: 350px;
        }
        #start-btn {
            background: linear-gradient(135deg, #00ffcc, #0099aa);
            border: none; padding: 15px 50px; font-size: 20px; 
            font-weight: bold; border-radius: 50px; cursor: pointer; margin-top: 25px;
            color: #000; box-shadow: 0 0 15px rgba(0,255,204,0.3);
            width: 100%;
        }
        #help-btn {
            margin-top: 15px; background: transparent; border: 1px solid #666; color: #aaa;
            padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; width: 100%;
        }
        /* æ™‚é–“è¨­å®šã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ */
        .time-selector { margin-top: 15px; text-align: center; }
        .time-select {
            background: #222; color: #fff; border: 1px solid #00ffcc; 
            padding: 10px; border-radius: 10px; font-size: 16px; width: 100px; text-align: center;
        }
        .time-label { font-size: 12px; color: #aaa; display: block; margin-bottom: 5px; }

        /* ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”»é¢ */
        #calibration-ui { display: none; text-align: center; background: rgba(0,0,0,0.85); padding: 30px; border-radius: 20px; border: 2px solid #ffcc00; width: 80%; max-width: 400px; }
        .calib-step { font-size: 14px; color: #aaa; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; }
        .calib-title { font-size: 24px; color: #ffcc00; font-weight: bold; margin-bottom: 10px; }
        .calib-desc { font-size: 16px; color: #fff; line-height: 1.5; }
        .calib-timer { font-size: 60px; color: #fff; font-weight: bold; margin-top: 15px; }

        /* æº–å‚™ä¸­ (Ready) */
        #ready-ui { display: none; text-align: center; }
        .ready-title { font-size: 30px; color: #fff; font-weight: bold; text-shadow: 0 0 10px #000; }
        .ready-count { font-size: 100px; color: #00ffcc; font-weight: bold; }

        /* è¨ˆæ¸¬ä¸­ */
        #recording-ui { display: none; text-align: center; width: 100%; }
        .timer { font-size: 80px; color: #fff; font-weight: bold; line-height: 1; }
        .realtime-box { 
            display: flex; justify-content: center; gap: 20px; margin-top: 10px; 
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px;
        }
        .rt-item { text-align: center; }
        .rt-label { font-size: 11px; color: #aaa; margin-bottom: 3px; }
        .rt-val { font-size: 32px; font-weight: bold; color: #00ffcc; }
        .rt-sub-val { font-size: 18px; color: #00ffcc; font-weight: bold; }
        .rt-unit { font-size: 14px; color: #888; margin-left: 2px;}

        /* çµæœç”»é¢ */
        #result-ui {
            display: none; pointer-events: auto; background: rgba(20,20,20,0.98);
            padding: 30px; border-radius: 20px; border: 2px solid #00ffcc;
            width: 340px; color: #fff; text-align: center;
        }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .res-box { background: #333; padding: 10px; border-radius: 8px; }
        .res-label { font-size: 10px; color: #aaa; margin-bottom: 5px; }
        .res-big { font-size: 24px; font-weight: bold; color: #fff; }
    </style>
</head>
<body>
    <video id="input_video" style="display:none" autoplay playsinline></video>

    <div class="hand-switch-container">
        <button class="hand-btn" id="btn-left" onclick="setHand('left')">å·¦è…• (Left)</button>
        <button class="hand-btn active" id="btn-right" onclick="setHand('right')">å³è…• (Right)</button>
    </div>

    <div id="manual-modal">
        <div class="manual-content">
            <span class="manual-badge">èªå®šä½œæ¥­ç™‚æ³•å£«ç›£ä¿®</span>
            <h2 style="color:#fff; margin-top:5px; border-bottom:1px solid #555; padding-bottom:15px;">å–æ‰±èª¬æ˜æ›¸ (v7)</h2>
            
            <div class="manual-h3">1. ç›®çš„ (Purpose)</div>
            <p class="manual-p">
                æœ¬ã‚¢ãƒ—ãƒªã¯ã€ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã‘ã‚‹ä¸Šè‚¢ãƒªãƒ¼ãƒå‹•ä½œã‚’å¯è¦–åŒ–ãƒ»è©•ä¾¡ã—ã¾ã™ã€‚<br>
                ã€Œé–‹å§‹ä½ç½®ã€ã¨ã€Œæœ€å¤§ä½ç½®ã€ã‚’è¨˜æ†¶ã—ã€<strong>ç©ºé–“ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¡¨ç¤º</strong>ã™ã‚‹ã“ã¨ã§ã€è¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¸ãˆãªãŒã‚‰è¨“ç·´ã‚’è¡Œãˆã¾ã™ã€‚
            </p>

            <div class="manual-h3">2. ä½¿ã„æ–¹ (Training Flow)</div>
            
            <p class="manual-p"><strong>STEP 1: è¨­å®š</strong><br>
            è¨“ç·´æ™‚é–“ï¼ˆ10ç§’ã€œ60ç§’ï¼‰ã‚’é¸æŠã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚</p>

            <p class="manual-p"><strong>STEP 2: ãƒ›ãƒ¼ãƒ ä½ç½®ç™»éŒ² (5ç§’)</strong><br>
            æ‰‹ã‚’<span style="color:#00ffcc;">ã€Œè†ã®ä¸Šã€ã‚„ã€Œæ‰‹å…ƒã€</span>ã«ç½®ã„ã¦é™æ­¢ã—ã¦ãã ã•ã„ã€‚<br>
            ã“ã“ã«<strong>é’ã„ãƒªãƒ³ã‚°</strong>ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚</p>
            
            <p class="manual-p"><strong>STEP 3: æœ€å¤§ãƒªãƒ¼ãƒç™»éŒ² (5ç§’)</strong><br>
            è…•ã‚’<span style="color:#ffcc00;">ã€Œé™ç•Œã¾ã§ã€</span>é ãã«ä¼¸ã°ã—ã¦ãã ã•ã„ã€‚<br>
            ã“ã“ã«<strong>é»„è‰²ã„ãƒªãƒ³ã‚°</strong>ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚</p>

            <p class="manual-p"><strong>STEP 4: å¾…æ©Ÿæ™‚é–“ (5ç§’)</strong><br>
            æ¸¬å®šå‰ã«5ç§’é–“ã®ä¼‘æ†©ãŒå…¥ã‚Šã¾ã™ã€‚é–‹å§‹ä½ç½®ã«æˆ»ã£ã¦æº–å‚™ã—ã¦ãã ã•ã„ã€‚</p>

            <p class="manual-p"><strong>STEP 5: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</strong><br>
            ç”»é¢ä¸Šã®ãƒªãƒ³ã‚°ã‚’ç›®æŒ‡ã—ã¦å‹•ã‹ã—ã¾ã™ã€‚<br>
            ãƒ»é»„è‰²ã„ãƒªãƒ³ã‚°ã«è¿‘ã¥ãã¨ã€Œãƒªãƒ¼ãƒã€<br>
            ãƒ»é’ã„ãƒªãƒ³ã‚°ã«æˆ»ã‚‹ã¨ã€Œ1å›ã€ã¨ã‚«ã‚¦ãƒ³ãƒˆã€‚</p>

            <div class="manual-h3">3. æ³¨æ„ç‚¹ (Notes)</div>
            <div class="manual-warn">
                <ul>
                    <li><strong>è‚©ã®èªè­˜:</strong> ç”»é¢ã«è‚©ã®ãƒãƒ¼ã‚«ãƒ¼ã¯å‡ºã¾ã›ã‚“ãŒã€AIã¯å†…éƒ¨ã§è‚©ã®ä½ç½®ã‚’è¦‹ã¦ã„ã¾ã™ã€‚ä½“ã”ã¨å‰ã«å€’ã‚Œè¾¼ã‚€ã¨æ­£ç¢ºãªãƒªãƒ¼ãƒï¼ˆè…•ã®ä¼¸ã³ï¼‰ãŒæ¸¬ã‚Œãªã„ãŸã‚ã€ä½“å¹¹ã¯èµ·ã“ã—ãŸã¾ã¾è…•ã‚’ä¼¸ã°ã—ã¦ãã ã•ã„ã€‚</li>
                    <li><strong>è¨“ç·´ãƒ¢ãƒ¼ãƒ‰:</strong> ç„¡ç†ã®ãªã„æ™‚é–“è¨­å®šã§è¡Œã£ã¦ãã ã•ã„ã€‚</li>
                </ul>
            </div>

            <div class="manual-close-wrapper">
                <button class="retry-btn" onclick="document.getElementById('manual-modal').style.display='none'">é–‰ã˜ã¦è¨ˆæ¸¬ã¸</button>
            </div>
        </div>
    </div>

    <div class="ui-layer">
        <div id="start-screen">
            <h2 style="color:#fff; margin-bottom: 5px;">Rehab Analytics Pro</h2>
            <div style="color:#aaa; font-size:14px;">Training Mode with Visual Targets</div>
            
            <div class="time-selector">
                <label class="time-label">è¨“ç·´æ™‚é–“ (Duration)</label>
                <select id="time-select" class="time-select">
                    <option value="10">10ç§’</option>
                    <option value="20">20ç§’</option>
                    <option value="30">30ç§’</option>
                    <option value="60">60ç§’</option>
                </select>
            </div>

            <button id="start-btn" onclick="startCalibrationStep1()">æ¸¬å®šé–‹å§‹</button>
            <button id="help-btn" onclick="document.getElementById('manual-modal').style.display='block'">èª¬æ˜æ›¸ã‚’è¦‹ã‚‹</button>
        </div>

        <div id="calibration-ui">
            <div class="calib-step" id="calib-step-label">STEP 1/2</div>
            <div class="calib-title" id="calib-title">ğŸ  ãƒ›ãƒ¼ãƒ ä½ç½®è¨­å®š</div>
            <div class="calib-desc" id="calib-desc">
                æ‰‹ã‚’<strong>ã€Œæ‰‹å…ƒã€</strong>ã«ç½®ã„ã¦<br>
                é’ã„ãƒªãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚
            </div>
            <div class="calib-timer" id="calib-timer">5</div>
        </div>

        <div id="ready-ui">
            <div class="ready-title">Get Ready...</div>
            <div class="ready-count" id="ready-count">5</div>
        </div>

        <div id="recording-ui">
            <div style="color:#ff3366; font-weight:bold; animation: blink 1s infinite;">â— RECORDING</div>
            <div class="timer" id="timer-val">10.0</div>
            
            <div class="realtime-box">
                <div class="rt-item">
                    <div class="rt-label">COUNT</div>
                    <div class="rt-val" id="rt-count">0</div>
                </div>
                <div class="rt-item">
                    <div class="rt-label">RANGE %</div>
                    <div class="rt-val"><span id="rt-percent">0</span><span class="rt-unit">%</span></div>
                </div>
                <div class="rt-item">
                    <div class="rt-label">SPEED</div>
                    <div class="rt-sub-val"><span id="rt-speed">0.0</span> <span style="font-size:10px">m/s</span></div>
                </div>
            </div>
        </div>

        <div id="result-ui">
            <h3 style="margin:0 0 15px 0; color:#00ffcc;">RESULT</h3>
            <div class="res-grid">
                <div class="res-box">
                    <div class="res-label">COUNT</div>
                    <div class="res-big" id="res-count">0</div>
                </div>
                <div class="res-box">
                    <div class="res-label">MAX REACH</div>
                    <div class="res-big"><span id="res-max-pct">0</span><span style="font-size:14px">%</span></div>
                </div>
                <div class="res-box">
                    <div class="res-label">MAX SPEED</div>
                    <div class="res-big"><span id="res-max-speed">0.0</span><span style="font-size:14px">m/s</span></div>
                </div>
                <div class="res-box">
                    <div class="res-label">TOTAL ENERGY</div>
                    <div class="res-big" id="res-energy">0.0</div>
                </div>
            </div>
            <button class="retry-btn" onclick="location.reload()">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <canvas id="output_canvas"></canvas>
    <div class="graph-wrapper"><canvas id="chart_canvas"></canvas></div>

    <script>
        // --- è¨­å®š (Setting) ---
        let targetHand = 16; 
        let targetShoulder = 12;

        function setHand(side) {
            document.getElementById('btn-left').classList.remove('active');
            document.getElementById('btn-right').classList.remove('active');
            document.getElementById(`btn-${side}`).classList.add('active');
            if(side === 'left') { targetHand = 15; targetShoulder = 11; }
            else { targetHand = 16; targetShoulder = 12; }
            pathHistory = [];
        }

        // --- å¤‰æ•° (Variables) ---
        let appState = 'idle'; // idle, calib1, calib2, pre-record, recording, result
        let lastTime = 0;
        let lastWrist = null;
        let targetDuration = 10; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ10ç§’
        
        // ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
        let calibMinDist = 0; 
        let calibMaxDist = 0; 
        let calibRange = 1;   

        // â˜… è¦–è¦šçš„ãƒãƒ¼ã‚«ãƒ¼ç”¨åº§æ¨™ (ç”»é¢ä¸Šã®x,y) â˜…
        let homePos2D = null; // {x, y}
        let maxPos2D = null;  // {x, y}

        // è¨ˆæ¸¬ãƒ‡ãƒ¼ã‚¿
        let sessionData = { totalEnergy: 0, maxPercent: 0, maxSpeed: 0, moveCount: 0 };
        
        // ã‚«ã‚¦ãƒ³ãƒˆé–¾å€¤
        let isReaching = false; 
        const THRESHOLD_HIGH = 0.80; 
        const THRESHOLD_LOW = 0.20;  

        // UI
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        let pathHistory = [];

        // ã‚°ãƒ©ãƒ•
        const ctxChart = document.getElementById('chart_canvas').getContext('2d');
        let chart = new Chart(ctxChart, {
            type: 'line',
            data: {
                labels: Array(60).fill(''),
                datasets: [{ 
                    data: Array(60).fill(0), 
                    borderColor: '#00ffcc', backgroundColor: 'rgba(0,255,204,0.1)', 
                    fill: true, tension: 0.3, pointRadius: 0 
                }]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, animation: false,
                scales: { y: { display: true, min: 0, max: 120, grid: { color: '#333'} }, x: { display: false } },
                plugins: { legend: { display: false } }
            }
        });

        // --- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹åˆ¶å¾¡ ---
        
        // STEP 1: ãƒ›ãƒ¼ãƒ ä½ç½®è¨­å®š
        function startCalibrationStep1() {
            // æ™‚é–“è¨­å®šã‚’å–å¾—
            const select = document.getElementById('time-select');
            targetDuration = parseInt(select.value, 10);

            appState = 'calib1';
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('calibration-ui').style.display = 'block';
            
            // UIæ›´æ–°
            document.getElementById('calib-step-label').innerText = "STEP 1/2";
            document.getElementById('calib-title').innerText = "ğŸ  ãƒ›ãƒ¼ãƒ ä½ç½® (é’)";
            document.getElementById('calib-desc').innerHTML = "æ‰‹ã‚’<strong>æ‰‹å…ƒ</strong>ã«ç½®ã„ã¦ãã ã•ã„ã€‚<br>ã“ã“ãŒã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ã§ã™ã€‚";
            document.getElementById('calib-title').style.color = "#00ffcc";

            calibMinDist = 10.0;
            let count = 5;
            document.getElementById('calib-timer').innerText = count;

            const cTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('calib-timer').innerText = count;
                } else {
                    clearInterval(cTimer);
                    startCalibrationStep2();
                }
            }, 1000);
        }

        // STEP 2: æœ€å¤§ãƒªãƒ¼ãƒè¨­å®š
        function startCalibrationStep2() {
            appState = 'calib2';
            
            document.getElementById('calib-step-label').innerText = "STEP 2/2";
            document.getElementById('calib-title').innerText = "ğŸ“ æœ€å¤§ãƒªãƒ¼ãƒ (é»„)";
            document.getElementById('calib-desc').innerHTML = "è…•ã‚’<strong>é™ç•Œã¾ã§</strong>ä¼¸ã°ã—ã¦ãã ã•ã„ã€‚<br>ã“ã“ãŒã‚´ãƒ¼ãƒ«åœ°ç‚¹ã§ã™ã€‚";
            document.getElementById('calib-title').style.color = "#ffcc00";

            calibMaxDist = 0; 
            let count = 5;
            document.getElementById('calib-timer').innerText = count;

            const cTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('calib-timer').innerText = count;
                } else {
                    clearInterval(cTimer);
                    
                    // ç¯„å›²è¨ˆç®—
                    calibRange = calibMaxDist - calibMinDist;
                    if (calibRange < 0.1) calibRange = 0.3; 
                    
                    document.getElementById('calibration-ui').style.display = 'none';
                    startReadyPhase(); // â˜…æ–°è¨­: å¾…æ©Ÿãƒ•ã‚§ãƒ¼ã‚ºã¸
                }
            }, 1000);
        }

        // STEP 2.5: å¾…æ©Ÿãƒ•ã‚§ãƒ¼ã‚º (5ç§’ã‚«ã‚¦ãƒ³ãƒˆ)
        function startReadyPhase() {
            appState = 'pre-record';
            document.getElementById('ready-ui').style.display = 'block';
            
            let count = 5;
            document.getElementById('ready-count').innerText = count;
            
            const cTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('ready-count').innerText = count;
                } else {
                    clearInterval(cTimer);
                    document.getElementById('ready-ui').style.display = 'none';
                    startMeasurement();
                }
            }, 1000);
        }

        // STEP 3: æœ¬ç•ªè¨ˆæ¸¬
        function startMeasurement() {
            appState = 'recording';
            document.getElementById('recording-ui').style.display = 'block';
            sessionData = { totalEnergy: 0, maxPercent: 0, maxSpeed: 0, moveCount: 0 };
            isReaching = false;

            let timeLeft = targetDuration; // è¨­å®šã—ãŸæ™‚é–“
            document.getElementById('timer-val').innerText = timeLeft.toFixed(1);

            const timer = setInterval(() => {
                timeLeft -= 0.1;
                if(timeLeft < 0) timeLeft = 0;
                document.getElementById('timer-val').innerText = timeLeft.toFixed(1);
                
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    finishMeasurement();
                }
            }, 100);
        }

        function finishMeasurement() {
            appState = 'result';
            document.getElementById('recording-ui').style.display = 'none';
            document.getElementById('result-ui').style.display = 'block';
            
            document.getElementById('res-count').innerText = sessionData.moveCount;
            document.getElementById('res-max-pct').innerText = sessionData.maxPercent.toFixed(0);
            document.getElementById('res-max-speed').innerText = sessionData.maxSpeed.toFixed(2);
            document.getElementById('res-energy').innerText = sessionData.totalEnergy.toFixed(1);
        }

        // --- MediaPipe Loop ---
        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseWorldLandmarks && results.poseWorldLandmarks[targetHand]) {
                const hand3D = results.poseWorldLandmarks[targetHand];
                const shoulder3D = results.poseWorldLandmarks[targetShoulder];
                const hand2D = results.poseLandmarks[targetHand];

                if (hand3D && shoulder3D) {
                    // è·é›¢è¨ˆç®— (å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ç”¨)
                    const dist = Math.sqrt(
                        Math.pow(hand3D.x - shoulder3D.x, 2) +
                        Math.pow(hand3D.y - shoulder3D.y, 2) +
                        Math.pow(hand3D.z - shoulder3D.z, 2)
                    );

                    // --- çŠ¶æ…‹å‡¦ç† ---
                    // 1. ãƒ›ãƒ¼ãƒ è¨­å®š
                    if (appState === 'calib1') {
                        calibMinDist = dist; 
                        homePos2D = { x: hand2D.x, y: hand2D.y }; // â˜…ç”»é¢ä½ç½®ã‚’è¨˜æ†¶
                    }
                    // 2. æœ€å¤§ãƒªãƒ¼ãƒè¨­å®š
                    else if (appState === 'calib2') {
                        if (dist > calibMaxDist) {
                            calibMaxDist = dist;
                            maxPos2D = { x: hand2D.x, y: hand2D.y }; // â˜…ç”»é¢ä½ç½®ã‚’è¨˜æ†¶
                        }
                    }
                    // 3. è¨ˆæ¸¬ä¸­
                    else if (appState === 'recording') {
                        let rawRatio = (dist - calibMinDist) / calibRange;
                        if (rawRatio < 0) rawRatio = 0;
                        if (rawRatio > 1.2) rawRatio = 1.2;
                        const percent = rawRatio * 100;

                        // UIæ›´æ–°
                        document.getElementById('rt-percent').innerText = percent.toFixed(0);
                        const data = chart.data.datasets[0].data;
                        data.shift(); data.push(percent); chart.update();

                        if(percent > sessionData.maxPercent) sessionData.maxPercent = percent;

                        // ã‚«ã‚¦ãƒ³ãƒˆ
                        if (!isReaching && rawRatio > THRESHOLD_HIGH) { 
                            isReaching = true;
                        } else if (isReaching && rawRatio < THRESHOLD_LOW) { 
                            isReaching = false;
                            sessionData.moveCount++;
                            document.getElementById('rt-count').innerText = sessionData.moveCount;
                        }

                        // Speed
                        const currentTime = Date.now();
                        if (lastWrist && lastTime > 0) {
                            const dt = (currentTime - lastTime) / 1000; 
                            if (dt > 0) {
                                const moveDist = Math.sqrt(Math.pow(hand3D.x - lastWrist.x, 2) + Math.pow(hand3D.y - lastWrist.y, 2) + Math.pow(hand3D.z - lastWrist.z, 2));
                                let speed = moveDist / dt; 
                                if (speed < 20) {
                                    sessionData.totalEnergy += (0.5 * speed * speed);
                                    if(speed > sessionData.maxSpeed) sessionData.maxSpeed = speed;
                                    document.getElementById('rt-speed').innerText = speed.toFixed(1);
                                }
                            }
                        }
                    }

                    // --- æç”» (Visuals) ---
                    const px = hand2D.x * canvasElement.width;
                    const py = hand2D.y * canvasElement.height;

                    // â˜…å›ºå®šãƒãƒ¼ã‚«ãƒ¼ã®è¡¨ç¤º (Recordingä¸­)
                    if (appState === 'recording' || appState === 'pre-record') {
                        if (homePos2D) drawRing(homePos2D.x * canvasElement.width, homePos2D.y * canvasElement.height, "#00FFFF", "HOME");
                        if (maxPos2D) drawRing(maxPos2D.x * canvasElement.width, maxPos2D.y * canvasElement.height, "#FFCC00", "MAX");
                    }

                    // ç¾åœ¨ã®æ‰‹ã®ãƒãƒ¼ã‚«ãƒ¼
                    drawMarker(px, py, isReaching ? "#FF3366" : "#00FFFF", "Hand");

                    lastWrist = hand3D;
                    lastTime = Date.now();
                }
            }
        }

        // æ‰‹ã®ãƒãƒ¼ã‚«ãƒ¼
        function drawMarker(x, y, color, label) {
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 12, 0, 2 * Math.PI);
            canvasCtx.fillStyle = color;
            canvasCtx.fill();
            canvasCtx.strokeStyle = "#fff";
            canvasCtx.lineWidth = 3;
            canvasCtx.stroke();
        }

        // å›ºå®šãƒªãƒ³ã‚°æç”»ç”¨
        function drawRing(x, y, color, label) {
            canvasCtx.beginPath();
            canvasCtx.arc(x, y, 25, 0, 2 * Math.PI); // å¤§ãã‚ã®ãƒªãƒ³ã‚°
            canvasCtx.strokeStyle = color;
            canvasCtx.lineWidth = 4;
            canvasCtx.stroke();
            
            canvasCtx.fillStyle = color;
            canvasCtx.font = "bold 14px Arial";
            canvasCtx.textAlign = "center";
            canvasCtx.fillText(label, x, y - 35);
        }

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true });
        pose.onResults(onResults);
        
        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();
    </script>
</body>
</html>